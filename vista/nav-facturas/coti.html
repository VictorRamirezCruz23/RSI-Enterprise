<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSI Enterprise Quotation System</title>
   <link rel="stylesheet" href="coti.css">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .resumen-filtros {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .btn-filtro {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
        }
        .btn-filtro:hover {
            background-color: #e5e7eb;
        }
        .btn-filtro.active {
            background-color: #0d2c54;
            color: white;
            border-color: #0d2c54;
        }
        .resumen-totales {
            text-align: center;
            background-color: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
        }
        #resumenTitulo {
            color: #1e3a8a;
            margin-top: 0;
            font-size: 1.2em;
        }
        .total-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #15803d;
            margin: 10px 0 0 0;
        }
        .btn.btn-info {
            background-color: #06b6d4;
            color: white;
        }
        .btn.btn-info:hover {
            background-color: #0891b2;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="container">
                <h1>üìã Cotizaciones - RSI Enterprise</h1>
                <button id="nuevaCotizacionBtn" class="btn btn-primary">
                    <span>‚ûï</span> Nueva Cotizaci√≥n
                </button>
                
                <a href="GraficasCoti.html" id="descargarTodasBtn" class="btn btn-secondary" style="display: none;">
                <span>üìà</span> Graficas de Cotisaciones
                </a>

                <button id="resumenCuentasBtn" class="btn btn-info" style="display: none;">
                    <span>üìä</span> Resumen de Cuentas
                </button>

                <a href="../nav-operadores/gestion_Tickets.html">
                <button class="btn btn-primary">
                    <span>üé´</span> ver mis tickets
                </button>


                </a>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <div class="search-section">
                    <input type="text" id="buscarInput" placeholder="üîç Buscar cotizaciones por n√∫mero o cliente..." class="search-input">
                </div>

                <div class="table-section">
                    <div class="table-header">
                        <h2>üìä Cotizaciones Generadas</h2>
                    </div>
                    <div class="table-container">
                        
                        <table class="cotizaciones-table">
                            <thead>
                                <tr>
                                    <th>N√∫mero</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Descripci√≥n</th>
                                    <th>Generado por:</th>
                                    <th>Estatus</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cotizacionesTableBody">
                                </tbody>
                        </table>
                    </div>

                </div> <div id="pagination-controls" class="pagination-container"></div>
                    </div>
            </div>
        </main>

        <div id="modalCotizacion" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">‚ú® Nueva Cotizaci√≥n</h2>
                    <button id="cerrarModalBtn" class="close-btn">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="cotizacionForm" class="form-section">
                        <div class="section-card empresa">
                            <h3>üè¢ Datos de la Empresa</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="empresaSelector">Sucursal</label>
                                    <select id="empresaSelector" name="empresaSelector" required>
                                        <option value="RSI NEZA">RSI NEZA</option>
                                        <option value="RSI IXT">RSI IXT</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="empresaRFC">RFC</label>
                                    <input type="text" id="empresaRFC" name="empresaRFC" value="XAXX010101000" required>
                                </div>
                                <div class="form-group full-width">
                                    <label for="empresaDireccion">Direcci√≥n Fiscal</label>
                                    <input type="text" id="empresaDireccion" name="empresaDireccion" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="empresaTelefono">Tel√©fono</label>
                                    <input type="tel" id="empresaTelefono" name="empresaTelefono" value="(55) 1234-5678" required>
                                </div>
                            </div>
                        </div>

                        <div class="section-card cliente">
                            <h3>üë§ Datos del Cliente</h3>
                            
                            <div class="cliente-search-container">
                                <input type="text" id="clienteSearch" class="search-input" placeholder="üîç Buscar cliente por nombre o RFC..." autocomplete="off">
                                <div id="clienteDropdown" class="cliente-dropdown">
                                    </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="clienteNombre">Nombre del Cliente</label>
                                    <input type="text" id="clienteNombre" name="clienteNombre" required>
                                </div>
                                <div class="form-group">
                                    <label for="clienteRFC">RFC</label>
                                    <input type="text" id="clienteRFC" name="clienteRFC">
                                </div>
                                <div class="form-group full-width">
                                    <label for="clienteDireccion">Direcci√≥n (Contacto 1)</label>
                                    <input type="text" id="clienteDireccion" name="clienteDireccion" required>
                                </div>
                                <div class="form-group">
                                    <label for="clienteTelefono">Tel√©fono</label>
                                    <input type="tel" id="clienteTelefono" name="clienteTelefono" required>
                                </div>
                            </div>
                        </div>

                        <div class="section-card cotizacion">
                            <h3>üìÑ Informaci√≥n de la Cotizaci√≥n</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="cotizacionNumero">N√∫mero de Cotizaci√≥n</label>
                                    <input type="text" id="cotizacionNumero" name="cotizacionNumero" required readonly>
                                </div>
                                <div class="form-group">
                                    <label for="tipoCotizacion">Tipo de Cotizaci√≥n</label>
                                    <select id="tipoCotizacion" name="tipoCotizacion" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="implementacion">Implementaci√≥n</option>
                                        <option value="proyecto">Proyecto</option>
                                        <option value="servicio">Servicio</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="cotizacionFecha">Fecha</label>
                                    <input type="date" id="cotizacionFecha" name="cotizacionFecha" required>
                                </div>
                                <div class="form-group">
                                    <label for="cotizacionVigencia">Vigencia (d√≠as)</label>
                                    <input type="number" id="cotizacionVigencia" name="cotizacionVigencia" value="30" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="cotizacionMoneda">Moneda</label>
                                    <select id="cotizacionMoneda" name="cotizacionMoneda" required>
                                        <option value="MXN">Peso Mexicano (MXN)</option>
                                        <option value="USD">D√≥lar Americano (USD)</option>
                                        <option value="EUR">Euro (EUR)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="tipoCredito">Tipo de Pago</label>
                                    <select id="tipoCredito" name="tipoCredito">
                                        <option value="">Seleccionar...</option>
                                        <option value="contado">Contado</option>
                                        <option value="credito">Cr√©dito</option>
                                        <option value="debido">Debido</option>
                                        <option value="transferencia">Transferencia</option>
                                    </select>
                                
                                </div>
                                <div id="creditOptions" class="credit-options">
                                    <h4>üí≥ Opciones de Cr√©dito</h4>
                                    <div class="credit-grid">
                                        <div class="form-group">
                                            <label for="diasCredito">D√≠as de Cr√©dito</label>
                                            <select id="diasCredito" name="diasCredito">
                                                <option value="">Seleccionar...</option>
                                                <option value="8">8 d√≠as</option>
                                                <option value="15">15 d√≠as</option>
                                                <option value="30">30 d√≠as</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label for="cotizacionDescripcion">Descripci√≥n (para b√∫squedas)</label>
                                    <textarea id="cotizacionDescripcion" name="cotizacionDescripcion" rows="3" 
                                        maxlength="500" 
                                        placeholder="Descripci√≥n breve de la cotizaci√≥n para b√∫squedas internas (m√°ximo 500 caracteres)..."></textarea>
                                    <small id="contadorCaracteres" style="color: #6b7280; display: block; text-align: right;">0/500 caracteres</small>
                                </div>
                            </div>
                        </div>

                        <div class="section-card productos">
                            <div class="section-header">
                                <h3>üõçÔ∏è Productos / Servicios</h3>
                                <button type="button" id="agregarItemBtn" class="btn btn-primary">
                                    <span>‚ûï</span> Agregar Item
                                </button>
                            </div>
                            <div class="table-container">
                                <table id="itemsTable" class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Mover</th>
                                            <th>Categor√≠a</th>
                                            <th>Unidad</th>
                                            <th>Descripci√≥n</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unitario</th>
                                            <th>Total</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsTableBody">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="section-card totales">
                            <h3>üí∞ Totales</h3>
                            <div class="totales-grid">
                                <div class="totales-row">
                                    <label>Subtotal:</label>
                                    <span id="subtotal">$0.00</span>
                                </div>
                                <div class="totales-row">
                                    <label for="descuento">Descuento (%):</label>
                                    <input type="number" id="descuento" name="descuento" value="0" min="0" max="100" step="0.01">
                                </div>
                                <div class="totales-row">
                                    <label for="impuesto">IVA (%):</label>
                                    <input type="number" id="impuesto" name="impuesto" value="16" min="0" max="100" step="0.01">
                                </div>
                               <div class="totales-row total-final">
    <label>Total:</label>
    <span id="total">$0.00</span>
</div>
                            </div>
                        </div>

                        <div class="section-card">
                            <h3>üìã T√©rminos y Condiciones</h3>
                            <div class="form-group">
                                <textarea id="terminos" name="terminos" rows="5" placeholder="Ingrese los t√©rminos y condiciones...">
1. La presente cotizaci√≥n se realiza en base a los requerimientos necesarios para la soluci√≥n tecnol√≥gica.
2. Condiciones de pago, 70% de anticipo y 30% al t√©rmino de la instalaci√≥n y funcionamiento.
3. En caso de cancelaci√≥n tendr√° una penalizaci√≥n del 20% en el total de la cotizaci√≥n.
4. Trabajo adicional que no est√© dentro de la cotizaci√≥n tendr√° un costo extra.
5. Los equipos tienen un a√±o de garant√≠a por defecto de f√°brica.
6. La instalaci√≥n tendr√° la garant√≠a de 2 meses siempre y cuando no cuente con da√±os o manipulaci√≥n.
                                </textarea>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="cancelarBtn" class="btn btn-secondary">‚ùå Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <span>üíæ</span> Generar Cotizaci√≥n PDF
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="confirmModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2>‚ö†Ô∏è Confirmar Acci√≥n</h2>
                    <button id="confirmCloseBtn" class="close-btn">√ó</button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                    <div class="form-actions">
                        <button id="confirmNo" class="btn btn-secondary">‚ùå No</button>
                        <button id="confirmYes" class="btn btn-danger">‚úÖ S√≠</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>‚è≥ Procesando...</p>
    </div>
<div id="modalPDF" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2> Vista Previa del PDF - Cotizaci√≥n</h2>
            <button id="cerrarPdfBtn" class="close-btn">√ó</button>
        </div>
        <div class="modal-body">
            <div class="pdf-container">
                </div>
        </div>
    </div>
</div>
    
    <div id="modalResumenCuentas" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üìä Resumen de Cuentas</h2>
                <button id="cerrarResumenBtn" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div id="resumenFiltros" class="resumen-filtros">
                    <button class="btn-filtro active" data-filtro="todos">Todos</button>
                    <button class="btn-filtro" data-filtro="en proceso">En Proceso</button>
                    <button class="btn-filtro" data-filtro="vendida">Vendidas</button>
                    <button class="btn-filtro" data-filtro="rechazada">Rechazadas</button>
                </div>
                <div id="resumenTotales" class="resumen-totales">
                    <h3 id="resumenTitulo">Total de Todas las Cotizaciones</h3>
                    <p id="resumenSumaTotal" class="total-amount">$0.00</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy,
            setDoc,
            getDoc,
            where 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        import { 
            getAuth, 
            onAuthStateChanged,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';


        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
            authDomain: "rsienterprise.firebaseapp.com",
            projectId: "rsienterprise",
            storageBucket: "rsienterprise.appspot.com",
            messagingSenderId: "1063117165770",
            appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Variables globales
        let cotizaciones = [];
        let filteredCotizaciones = []; 
        let currentPage = 1;           
        const rowsPerPage = 30;        
        let clientes = [];
        let items = [];
        let contadores = {};
        let isEditing = false;
        let editingId = null;
        let isManualEntry = false;
        let contadorCotizaciones = 1;
        let currentUser = null;



//Funcion para la autenticacion de usuario
async function inicializarApp() {
    try {
        // Configurar el observador de autenticaci√≥n
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await cargarInformacionUsuario(user.email);
                
                const botonReporte = document.getElementById('descargarTodasBtn');
                const botonResumen = document.getElementById('resumenCuentasBtn'); 
                const nombresAutorizados = [
                    "Sergio Rodriguez Murillo",
                    "Tom√°s Ismael Rodriguez Murillo",
                    "Emanuel Jesus Campa Ramirez"
                ];

                if (currentUser && nombresAutorizados.includes(currentUser.nombreCompleto)) {
                    botonReporte.style.display = 'inline-block';
                    botonResumen.style.display = 'inline-block';
                }

                await cargarClientes();
                await cargarCotizaciones();
                await cargarContadores();
                inicializarEmpresa();
                
                document.getElementById('tipoCotizacion').addEventListener('change', async function() {
                    if (this.value) {
                        await generarNumeroCotizacion();
                    } else {
                        document.getElementById('cotizacionNumero').value = '';
                    }
                });
                
                establecerFechaActual();
                document.getElementById('cotizacionNumero').value = '';
            } else {
                Swal.fire({
                    title: 'Acceso no autorizado',
                    text: 'Debes iniciar sesi√≥n para acceder a esta funci√≥n',
                    icon: 'warning',
                    confirmButtonText: 'Iniciar sesi√≥n'
                }).then(() => {
                    window.location.href = '../nav-visitantes/inicio-de-sesion.html';
                });
            }
        });
    } catch (error) {
        console.error('Error en inicializaci√≥n:', error);
        mostrarAlerta('Error al inicializar la aplicaci√≥n', 'error');
    }
}



        async function cargarInformacionUsuario(email) {
            try {
                const q = query(collection(db, 'colaboradores'), where("CORREO ELECTR√ìNICO EMPRESARIAL", "==", email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    currentUser.nombreCompleto = doc.data().NOMBRE || email;
                } else {
                    currentUser.nombreCompleto = email; 
                }
            } catch (error) {
                console.error('Error al cargar informaci√≥n del usuario:', error);
                currentUser.nombreCompleto = email; 
            }
        }
        
        const MAX_PDF_SIZE = 1024 * 1024;

        const empresasDirecciones = {
            'RSI IXT': {
                nombre: 'RSI ENTERPRISE IXTAPALUCA',
                direccion: 'Av. Morelos 10, Pueblo San Francisco Acuautla, 56587 Ixtapaluca, M√©x.',
                telefono: '+52 1 55 7690 8248',
                rfc: 'RSI1810319G0'
            },
            'RSI NEZA': {
                nombre: 'RSI ENTERPRISE NEZAHUALC√ìYOTL',
                direccion: '31 MZ102 LT20 EL SOL 57200',
                telefono: '+52 1 55 7690 8248',
                rfc: 'RSI1810319G0'
            }
        };

        // Elementos del DOM
        const modalCotizacion = document.getElementById('modalCotizacion');
        const modalPDF = document.getElementById('modalPDF');
        const confirmModal = document.getElementById('confirmModal');
        const cotizacionForm = document.getElementById('cotizacionForm');
        const nuevaCotizacionBtn = document.getElementById('nuevaCotizacionBtn');
        const cerrarModalBtn = document.getElementById('cerrarModalBtn');
        const cancelarBtn = document.getElementById('cancelarBtn');
        const cerrarPdfBtn = document.getElementById('cerrarPdfBtn');
        const confirmCloseBtn = document.getElementById('confirmCloseBtn');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const agregarItemBtn = document.getElementById('agregarItemBtn');
        const cotizacionesTableBody = document.getElementById('cotizacionesTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        const buscarInput = document.getElementById('buscarInput');
        const modalTitle = document.getElementById('modalTitle');
        
        const resumenCuentasBtn = document.getElementById('resumenCuentasBtn');
        const modalResumenCuentas = document.getElementById('modalResumenCuentas');
        const cerrarResumenBtn = document.getElementById('cerrarResumenBtn');
        const resumenFiltrosContainer = document.getElementById('resumenFiltros');

        cotizacionForm.addEventListener('input', guardarFormularioLocalmente);

        const clienteSearch = document.getElementById('clienteSearch');
        const clienteDropdown = document.getElementById('clienteDropdown');
        const clienteNombre = document.getElementById('clienteNombre');
        const clienteRFC = document.getElementById('clienteRFC');
        const clienteDireccion = document.getElementById('clienteDireccion');
        const clienteTelefono = document.getElementById('clienteTelefono');

        const empresaSelector = document.getElementById('empresaSelector');
        const empresaDireccion = document.getElementById('empresaDireccion');
        const empresaRFC = document.getElementById('empresaRFC');
        const empresaTelefono = document.getElementById('empresaTelefono');

        const tipoCredito = document.getElementById('tipoCredito');
        const creditOptions = document.getElementById('creditOptions');
        const diasCredito = document.getElementById('diasCredito');

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', inicializarApp);
        nuevaCotizacionBtn.addEventListener('click', mostrarModalNuevaCotizacion);
        cerrarModalBtn.addEventListener('click', cerrarModal);
        cancelarBtn.addEventListener('click', cerrarModal);
        cerrarPdfBtn.addEventListener('click', cerrarModalPDF);
        confirmCloseBtn.addEventListener('click', cerrarModalConfirm);
        cotizacionForm.addEventListener('submit', manejarSubmitFormulario);
        agregarItemBtn.addEventListener('click', agregarItem);
        confirmNo.addEventListener('click', cerrarModalConfirm);
        buscarInput.addEventListener('input', filtrarCotizaciones);
        resumenCuentasBtn.addEventListener('click', mostrarModalResumen);
        cerrarResumenBtn.addEventListener('click', () => modalResumenCuentas.classList.remove('show'));
        resumenFiltrosContainer.addEventListener('click', handleFiltroClick);
        empresaSelector.addEventListener('change', handleEmpresaChange);
        tipoCredito.addEventListener('change', handleTipoCreditoChange);
        document.getElementById('descuento').addEventListener('input', calcularTotales);
        document.getElementById('impuesto').addEventListener('input', calcularTotales);
        clienteSearch.addEventListener('input', buscarClientes);
        clienteSearch.addEventListener('focus', mostrarDropdown);
        
        // --- LISTENER DEFINITIVO PARA EL TECLADO ---
        itemsTableBody.addEventListener('keydown', manejarTecladoItems);


        document.addEventListener('click', function(e) {
            if (!e.target.closest('.cliente-search-container')) {
                ocultarDropdown();
            }
        });

        itemsTableBody.addEventListener('dragover', e => {
            e.preventDefault(); 
            const afterElement = getDragAfterElement(itemsTableBody, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable) { 
                if (afterElement == null) {
                    itemsTableBody.appendChild(draggable);
                } else {
                    itemsTableBody.insertBefore(draggable, afterElement);
                }
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // === FUNCI√ìN DEFINITIVA PARA EL TECLADO ===
        function manejarTecladoItems(e) {
            // Revisa si la tecla presionada es "Tab" O si es "Enter"
            if (e.key === 'Tab' || (e.key === 'Enter' && e.target.tagName.toLowerCase() !== 'textarea')) {
                // 1. Previene la acci√≥n por defecto de la tecla.
                // ¬°IMPORTANTE! Esto anula la navegaci√≥n con Tab.
                e.preventDefault();
                
                // 2. Llama a la funci√≥n para agregar un nuevo √≠tem.
                agregarItem();

                // 3. Mueve el cursor al campo de "Descripci√≥n" de la nueva fila.
                const nuevaFila = itemsTableBody.lastElementChild;
                if (nuevaFila) {
                    const campoDescripcion = nuevaFila.querySelector('.item-descripcion');
                    if (campoDescripcion) {
                        campoDescripcion.focus();
                    }
                }
            }
        }


        modalCotizacion.addEventListener('click', function(e) { if (e.target === modalCotizacion) {} });
        window.addEventListener('beforeunload', (event) => {
            if (modalCotizacion.classList.contains('show')) {
                event.preventDefault();
                event.returnValue = '';
            }
        });
        modalPDF.addEventListener('click', function(e) { if (e.target === modalPDF) {} });
        confirmModal.addEventListener('click', function(e) { if (e.target === confirmModal) {} });
       
        async function cargarContadores() {
            try {
                const contadoresSnapshot = await getDocs(collection(db, 'contadoresCotizaciones'));
                contadoresSnapshot.forEach((doc) => {
                    contadores[doc.id] = doc.data().count || 0;
                });
            } catch (error) {
                console.error('Error al cargar contadores:', error);
            }
        }

        function inicializarEmpresa() { handleEmpresaChange(); }
        function handleEmpresaChange() {
            const empresaSeleccionada = empresaSelector.value;
            const empresaData = empresasDirecciones[empresaSeleccionada];
            empresaDireccion.value = empresaData.direccion;
            empresaRFC.value = empresaData.rfc;
            empresaTelefono.value = empresaData.telefono;
        }
        function handleTipoCreditoChange() {
            const tipo = tipoCredito.value;
            if (tipo === 'credito' || tipo === 'debido') {
                creditOptions.classList.add('show');
            } else {
                creditOptions.classList.remove('show');
                diasCredito.value = '';
            }
        }

        async function cargarClientes() {
            try {
                const querySnapshot = await getDocs(collection(db, 'clientes'));
                clientes = [];
                querySnapshot.forEach((doc) => {
                    const clienteData = doc.data();
                    const limpiarValor = (valor) => (!valor || ['N/A', 'undefined', 'null'].includes(valor)) ? '' : String(valor).trim();
                    const direccionPartes = [limpiarValor(clienteData.Calle), limpiarValor(clienteData.Colonia), limpiarValor(clienteData['Codigo Postal'])].filter(Boolean);
                    const telefonoPartes = [limpiarValor(clienteData.Telefono), limpiarValor(clienteData.Movil)].filter(Boolean);
                    clientes.push({
                        id: doc.id,
                        nombre: limpiarValor(clienteData.Nombre) || 'Cliente sin nombre',
                        nombreComercial: limpiarValor(clienteData['Nombre Comercial']),
                        rfc: limpiarValor(clienteData.RFC),
                        contacto1: direccionPartes.length > 0 ? direccionPartes.join(', ') : 'Direcci√≥n no disponible',
                        telefono1: telefonoPartes.length > 0 ? telefonoPartes.join(' / ') : 'Tel√©fono no disponible'
                    });
                });

               const clientesEspecificos = [
                    { nombre: 'LATAMGYM S.A.P.I. DE C.V.', rfc: 'LAT110824BJ4', contacto1: 'AV PASEO DE LA REFORMA 296 PISO 16 CUAUHT√âMOC, C.D.MX. CP: 06600' },
                    { nombre: 'TIENDAS CHEDRAUI S.A.B. DE C.V.', rfc: 'TCH850701RM1', contacto1: 'AV. CONSTITUYENTES 1150 MIGUEL HIDALGO, C.D.MX. CP: 11950' },
                    { nombre: 'GRUPO ZORRO ABARROTERO', rfc: 'GZA9104307K6', contacto1: 'AV. CENTENARIO 2188 GUSTAVO A. MADERO, C.D. MX. CP: 07420' },
                    { nombre: 'MILANO OPERADORA', rfc: 'DIS880803JW8', contacto1: 'PUEBLA 329 CUAUHT√âMOC, C.D.MX. CP: 06700' },
                    { nombre: 'LILIA ALAVEZ MALDONADO', rfc: 'AAML7804101K1', contacto1: 'RANCHO EL ENCANTO 35 CUAUTITL√ÅN IZCALLI, EDO. M√âX. CP: 54725' },
                    { nombre: 'LOGISTICA DE COMERCIO EXTERIOR SHEKINAH', rfc: 'LCE140605TJ2', contacto1: 'CALLE 3 194 NEZAHUALC√ìYOTL, EDO. M√âX. CP: 57200' },
                    { nombre: 'FLECHA ABARROTERA', rfc: 'FAB990222BG4', contacto1: 'CARRETERA XOCHIMILCO TULYEHUALCO 3024 XOCHIMILCO, C.D.MX. CP: 16429' },
                    { nombre: 'EL CAZADOR COMERCIAL ABARROTERO', rfc: 'CCA910626QT9', contacto1: 'AV. ZONA 4 SECTOR 4 CP: 09040' },
                    { nombre: 'CONSULTORIA INTEGRAL BETANZOS', rfc: 'CIB220427H25', contacto1: 'MEXICA 523-16C CHIMALHUAC√ÅN, EDO. M√âX. CP: 56366' },
                    { nombre: 'LEVADURAS Y AVIOS AZTECA', rfc: 'LAA080513DE1', contacto1: 'CALLE 4 184 IZTAPALAPA, C.D.MX. CP: 09070' }
                ];

                clientesEspecificos.forEach(clienteEspecifico => {
                    if (!clientes.some(c => c.nombre.toLowerCase() === clienteEspecifico.nombre.toLowerCase())) {
                        clientes.unshift({ id: `temp-${Date.now()}-${Math.random()}`, telefono1: '', nombreComercial: clienteEspecifico.nombre, ...clienteEspecifico });
                    }
                });

                const nombresEspecificos = ['TIENDAS CHEDRAUI', 'GRUPO ZORRO ABARROTERO', 'LEVADURAS Y AVIOS AZTECA', 'LATAMGYM'];
                clientes.sort((a, b) => {
                    const aEsEspecifico = nombresEspecificos.includes(a.nombre.toUpperCase());
                    const bEsEspecifico = nombresEspecificos.includes(b.nombre.toUpperCase());
                    if (aEsEspecifico && !bEsEspecifico) return -1;
                    if (!aEsEspecifico && bEsEspecifico) return 1;
                    if (aEsEspecifico && bEsEspecifico) return nombresEspecificos.indexOf(a.nombre.toUpperCase()) - nombresEspecificos.indexOf(b.nombre.toUpperCase());
                    return a.nombre.localeCompare(b.nombre);
                });
            } catch (error) {
                console.error('Error al cargar clientes:', error);
                mostrarAlerta('Error al cargar clientes de Firebase.', 'warning');
            }
        }

       function buscarClientes() {
            const termino = clienteSearch.value.toLowerCase().trim();
            if (termino.length === 0) { mostrarDropdown(); return; }
            const clientesFiltrados = clientes.filter(c => 
                (c.nombre && c.nombre.toLowerCase().includes(termino)) ||
                (c.rfc && c.rfc.toLowerCase().includes(termino)) ||
                (c.nombreComercial && c.nombreComercial.toLowerCase().includes(termino))
            );
            mostrarOpcionesClientes(clientesFiltrados, termino);
        }

        function mostrarDropdown() { mostrarOpcionesClientes(clientes.slice(0, 10)); }
        function ocultarDropdown() { clienteDropdown.classList.remove('show'); }
        function mostrarOpcionesClientes(clientesFiltrados, termino = '') {
            clienteDropdown.innerHTML = '';
            clientesFiltrados.forEach(cliente => {
                const option = document.createElement('div');
                option.className = 'cliente-option';
                option.innerHTML = `<div><strong>${cliente.nombre}</strong></div><div class="cliente-info">${cliente.rfc ? 'RFC: ' + cliente.rfc : 'Sin RFC'}</div>`;
                option.addEventListener('click', () => seleccionarCliente(cliente));
                clienteDropdown.appendChild(option);
            });
            const manualOption = document.createElement('div');
            manualOption.className = 'cliente-option manual';
            manualOption.innerHTML = `<div><strong>‚úèÔ∏è Entrada Manual</strong></div><div class="cliente-info">Escribir datos del cliente manualmente</div>`;
            manualOption.addEventListener('click', activarEntradaManual);
            clienteDropdown.appendChild(manualOption);
            if (clientesFiltrados.length === 0 && termino) {
                const noResultsOption = document.createElement('div');
                noResultsOption.className = 'cliente-option';
                noResultsOption.innerHTML = `<div style="color: #6b7280; font-style: italic;">No se encontraron clientes con "${termino}"</div>`;
                clienteDropdown.insertBefore(noResultsOption, manualOption);
            }
            clienteDropdown.classList.add('show');
        }

        function seleccionarCliente(cliente) {
            isManualEntry = false;
            clienteSearch.value = cliente.nombre;
            clienteNombre.value = cliente.nombre;
            clienteRFC.value = cliente.rfc;
            clienteDireccion.value = cliente.contacto1;
            clienteTelefono.value = cliente.telefono1;
            [clienteNombre, clienteRFC, clienteDireccion, clienteTelefono].forEach(field => {
                field.readOnly = true;
                field.style.backgroundColor = '#f0f9ff';
                field.style.borderColor = '#3b82f6';
            });
            ocultarDropdown();
        }

        function activarEntradaManual() {
            isManualEntry = true;
            clienteSearch.value = '';
            [clienteNombre, clienteRFC, clienteDireccion, clienteTelefono].forEach(field => {
                field.value = '';
                field.readOnly = false;
                field.style.backgroundColor = 'white';
                field.style.borderColor = '#e5e7eb';
            });
            ocultarDropdown();
            clienteNombre.focus();
        }

        function mostrarModalNuevaCotizacion() {
            isEditing = false;
            editingId = null;
            resetearFormulario(); 
            cargarFormularioLocal(); 
            modalCotizacion.classList.add('show');
        }

        function resetearFormulario() {
            cotizacionForm.reset();
            items = [];
            itemsTableBody.innerHTML = '';
            document.getElementById('tipoCotizacion').value = '';
            document.getElementById('cotizacionNumero').value = '';
            inicializarEmpresa();
            establecerFechaActual();
            agregarItem();
            clienteSearch.value = '';
            activarEntradaManual(); 
            creditOptions.classList.remove('show');
            tipoCredito.value = '';
            diasCredito.value = '';
            cotizacionForm.querySelector('button[type="submit"]').innerHTML = '<span>üíæ</span> Generar Cotizaci√≥n PDF';
            isEditing = false;
            editingId = null;
            modalTitle.textContent = '‚ú® Nueva Cotizaci√≥n';
        }

        function cerrarModal() { modalCotizacion.classList.remove('show'); }
        function cerrarModalPDF() { modalPDF.classList.remove('show'); }
        function cerrarModalConfirm() { confirmModal.classList.remove('show'); }

       async function generarNumeroCotizacion() {
            try {
                const tipoCotizacion = document.getElementById('tipoCotizacion').value;
                if (!tipoCotizacion) { document.getElementById('cotizacionNumero').value = ''; return; }
                const contadorRef = doc(db, 'contadoresCotizaciones', tipoCotizacion);
                const contadorDoc = await getDoc(contadorRef);
                let nuevoContador = contadorDoc.exists() ? contadorDoc.data().count + 1 : 1;
                const hoy = new Date();
                const fechaStr = `${hoy.getFullYear()}${String(hoy.getMonth() + 1).padStart(2, '0')}${String(hoy.getDate()).padStart(2, '0')}`;
                const numeroCompleto = `RSI-${fechaStr}-${tipoCotizacion.toUpperCase()}-${nuevoContador}`;
                document.getElementById('cotizacionNumero').value = numeroCompleto;
                contadores[tipoCotizacion] = nuevoContador;
            } catch (error) {
                console.error('Error al generar n√∫mero de cotizaci√≥n:', error);
                const fecha = new Date();
                document.getElementById('cotizacionNumero').value = `RSI-${fecha.getFullYear()}${String(fecha.getMonth() + 1).padStart(2, '0')}${String(fecha.getDate()).padStart(2, '0')}-MANUAL-1`;
            }
        }
                
        function establecerFechaActual() {
            document.getElementById('cotizacionFecha').value = new Date().toISOString().split('T')[0];
        }

       function agregarItem() {
            const row = document.createElement('tr');
            row.draggable = true; 
            row.innerHTML = `
                <td><span class="drag-handle" title="Arrastrar para reordenar">‚†ø</span></td>
                <td>
                    <select class="item-categoria" required><option value="">Seleccionar...</option><option value="CCTV">üìπ CCTV</option><option value="DH">üè† DETECTOR DE HUMO</option><option value="CA">üîê CONTROL DE ACCESOS</option><option value="ALARMA INTRUSION">üö® ALARMA INTRUSION</option><option value="MULTIMEDIA">üì∫ MULTIMEDIA</option><option value="REDES">üõú REDES TRANSPORTE DE DATOS</option><option value="OTRO">üì¶ OTRO</option></select>
                </td>
                <td>
                    <select class="item-tipo-tecnologia" required><option value="">Seleccionar...</option><option value="servicio">üîß Servicio</option><option value="pieza">‚öôÔ∏è Pieza</option><option value="kit">üì¶ Kit</option><option value="par">üë• Par</option><option value="cm">üêõ Centimetro</option><option value="m">üöá Metro</option></select>
                </td>
                <td><input type="text" class="item-descripcion" placeholder="Descripci√≥n del producto/servicio" minlength="5" maxlength="200" required></td>
                <td><input type="number" class="item-cantidad" min="1" value="1" step="0.01" required></td>
                <td><input type="number" class="item-precio" min="0" step="0.01" placeholder="0.00" required></td>
                <td class="item-total">$0.00</td>
                <td><button type="button" class="btn btn-danger btn-small eliminar-item"><span>üóëÔ∏è</span></button></td>
            `;
            itemsTableBody.appendChild(row);
            row.addEventListener('dragstart', () => { setTimeout(() => row.classList.add('dragging'), 0); });
            row.addEventListener('dragend', () => row.classList.remove('dragging'));
            row.querySelector('.item-cantidad').addEventListener('input', () => calcularTotalItem(row));
            row.querySelector('.item-precio').addEventListener('input', () => calcularTotalItem(row));
            row.querySelector('.eliminar-item').addEventListener('click', () => eliminarItem(row));
            calcularTotalItem(row);
        }
        
        function calcularTotalItem(row) {
            const cantidad = parseFloat(row.querySelector('.item-cantidad').value) || 0;
            const precio = parseFloat(row.querySelector('.item-precio').value) || 0;
            row.querySelector('.item-total').textContent = formatearMoneda(cantidad * precio);
            calcularTotales();
        }

        function guardarFormularioLocalmente() {
            if (!modalCotizacion.classList.contains('show')) return;
            const datosFormulario = new FormData(cotizacionForm);
            const cotizacionData = Object.fromEntries(datosFormulario.entries());
            cotizacionData.items = Array.from(itemsTableBody.children).map(row => ({
                categoria: row.querySelector('.item-categoria').value,
                tipoTecnologia: row.querySelector('.item-tipo-tecnologia').value,
                descripcion: row.querySelector('.item-descripcion').value,
                cantidad: row.querySelector('.item-cantidad').value,
                precio: row.querySelector('.item-precio').value,
            }));
            localStorage.setItem('cotizacionEnProgreso', JSON.stringify(cotizacionData));
        }

        function cargarFormularioLocal() {
            const datosGuardados = localStorage.getItem('cotizacionEnProgreso');
            if (datosGuardados) {
                const cotizacionData = JSON.parse(datosGuardados);
                Object.keys(cotizacionData).forEach(key => {
                    const input = cotizacionForm.querySelector(`[name="${key}"]`);
                    if (input && key !== 'items') input.value = cotizacionData[key];
                });
                itemsTableBody.innerHTML = ''; 
                if (cotizacionData.items && cotizacionData.items.length > 0) {
                    cotizacionData.items.forEach(item => {
                        agregarItem(); 
                        const nuevaFila = itemsTableBody.lastElementChild;
                        nuevaFila.querySelector('.item-categoria').value = item.categoria;
                        nuevaFila.querySelector('.item-tipo-tecnologia').value = item.tipoTecnologia;
                        nuevaFila.querySelector('.item-descripcion').value = item.descripcion;
                        nuevaFila.querySelector('.item-cantidad').value = item.cantidad;
                        nuevaFila.querySelector('.item-precio').value = item.precio;
                        calcularTotalItem(nuevaFila);
                    });
                }
                handleTipoCreditoChange();
                mostrarAlerta('üìù Se recuper√≥ una cotizaci√≥n no guardada.', 'info');
            }
        }

        function limpiarFormularioLocal() { localStorage.removeItem('cotizacionEnProgreso'); }
        function eliminarItem(row) {
            if (itemsTableBody.children.length > 1) {
                row.remove();
                calcularTotales();
            } else {
                mostrarAlerta('Debe mantener al menos un item.', 'warning');
            }
        }

        document.getElementById('cotizacionDescripcion').addEventListener('input', function() {
            const contador = document.getElementById('contadorCaracteres');
            const caracteres = this.value.length;
            contador.textContent = `${caracteres}/500 caracteres`;
            contador.style.color = caracteres >= 500 ? '#ef4444' : '#6b7280';
        });

        function calcularTotales() {
            let subtotal = 0;
            Array.from(itemsTableBody.children).forEach(row => {
                const cantidad = parseFloat(row.querySelector('.item-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.item-precio').value) || 0;
                subtotal += cantidad * precio;
            });
            const descuentoPorcentaje = parseFloat(document.getElementById('descuento').value) || 0;
            const impuestoPorcentaje = parseFloat(document.getElementById('impuesto').value) || 0;
            const descuentoMonto = subtotal * (descuentoPorcentaje / 100);
            const subtotalConDescuento = subtotal - descuentoMonto;
            const impuestoMonto = subtotalConDescuento * (impuestoPorcentaje / 100);
            const total = subtotalConDescuento + impuestoMonto;
            document.getElementById('subtotal').textContent = formatearMoneda(subtotal);
            document.getElementById('total').textContent = formatearMoneda(total);
        }

        function formatearMoneda(cantidad) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(cantidad);
        }

        function agruparTecnologias(items) {
            const grupos = {};
            items.forEach(item => {
                const categoria = item.categoria || 'OTRO';
                if (!grupos[categoria]) grupos[categoria] = [];
                grupos[categoria].push(item);
            });
            return grupos;
        }

        function descargarPDFLocal(pdfBlob, nombreArchivo) {
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            if (!currentUser) {
                Swal.fire({ title: 'Acceso no autorizado', text: 'Debes iniciar sesi√≥n', icon: 'warning' });
                return;
            }
            const tipoCotizacion = document.getElementById('tipoCotizacion').value;
            if (!tipoCotizacion) { mostrarAlerta('Debe seleccionar un tipo de cotizaci√≥n', 'error'); return; }
            mostrarLoading(true);
            try {
                const datosFormulario = new FormData(cotizacionForm);
                const cotizacionData = Object.fromEntries(datosFormulario.entries());
                const empresaInfo = empresasDirecciones[empresaSelector.value];
                cotizacionData.empresaNombre = empresaInfo.nombre;
                cotizacionData.empresaDireccion = empresaInfo.direccion;
                cotizacionData.empresaTelefono = empresaInfo.telefono;
                cotizacionData.empresaRFC = empresaInfo.rfc;
                
                const itemsData = Array.from(itemsTableBody.children).map(row => ({
                    categoria: row.querySelector('.item-categoria').value,
                    tipoTecnologia: row.querySelector('.item-tipo-tecnologia').value,
                    descripcion: row.querySelector('.item-descripcion').value,
                    cantidad: parseFloat(row.querySelector('.item-cantidad').value),
                    precio: parseFloat(row.querySelector('.item-precio').value),
                    total: (parseFloat(row.querySelector('.item-cantidad').value) || 0) * (parseFloat(row.querySelector('.item-precio').value) || 0)
                }));
                
                if (itemsData.some(item => !item.descripcion || isNaN(item.cantidad) || isNaN(item.precio))) {
                    mostrarAlerta('Todos los items deben tener datos v√°lidos.', 'error');
                    mostrarLoading(false);
                    return;
                }
                
                cotizacionData.items = itemsData;
                cotizacionData.esEntradaManual = isManualEntry;
                cotizacionData.tipoCotizacion = tipoCotizacion;
                
                const subtotal = itemsData.reduce((sum, item) => sum + item.total, 0);
                const descuentoPorcentaje = parseFloat(cotizacionData.descuento) || 0;
                const impuestoPorcentaje = parseFloat(cotizacionData.impuesto) || 0;
                const descuentoMonto = subtotal * (descuentoPorcentaje / 100);
                const subtotalConDescuento = subtotal - descuentoMonto;
                const impuestoMonto = subtotalConDescuento * (impuestoPorcentaje / 100);
                
                cotizacionData.subtotal = subtotal;
                cotizacionData.descuentoMonto = descuentoMonto;
                cotizacionData.impuestoMonto = impuestoMonto;
                cotizacionData.totalFinal = subtotalConDescuento + impuestoMonto;
                
                if (isEditing && editingId) {
                    cotizacionData.generadoPor = cotizaciones.find(c => c.id === editingId).generadoPor;
                    cotizacionData.fechaCreacion = cotizaciones.find(c => c.id === editingId).fechaCreacion;
                    await updateDoc(doc(db, 'cotizacionPdf', editingId), cotizacionData);
                    mostrarAlerta('‚úÖ Cotizaci√≥n actualizada', 'success');
                } else {
                    cotizacionData.fechaCreacion = new Date().toISOString();
                    cotizacionData.estatus = 'en proceso';
                    cotizacionData.generadoPor = { uid: currentUser.uid, email: currentUser.email, nombre: currentUser.nombreCompleto, fechaGeneracion: new Date().toISOString() };
                    const contadorRef = doc(db, 'contadoresCotizaciones', tipoCotizacion);
                    await setDoc(contadorRef, { count: contadores[tipoCotizacion] }, { merge: true });
                    await addDoc(collection(db, 'cotizacionPdf'), cotizacionData);
                    mostrarAlerta('‚úÖ Cotizaci√≥n creada', 'success');
                }
                
                const pdfBlob = await generarPDF(cotizacionData);
                descargarPDFLocal(pdfBlob, `cotizacion-${cotizacionData.cotizacionNumero}.pdf`);
                await cargarCotizaciones();
                cerrarModal();
                limpiarFormularioLocal();
            } catch (error) {
                console.error('Error al guardar cotizaci√≥n:', error);
                mostrarAlerta('‚ùå Error al guardar: ' + error.message, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        async function verPDF(id) {
            const cotizacion = cotizaciones.find(c => c.id === id);
            if (!cotizacion) { mostrarAlerta('No se encontr√≥ la cotizaci√≥n', 'warning'); return; }
            try {
                mostrarLoading(true);
                const pdfBlob = await generarPDF(cotizacion);
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const pdfContainer = modalPDF.querySelector('.pdf-container');
                pdfContainer.innerHTML = `<iframe src="${pdfUrl}" style="width: 100%; height: calc(80vh - 60px); border: none;"></iframe>`;
                modalPDF.classList.add('show');
                cerrarPdfBtn.onclick = () => {
                    modalPDF.classList.remove('show');
                    URL.revokeObjectURL(pdfUrl);
                };
            } catch (error) {
                console.error('Error al generar PDF:', error);
                mostrarAlerta('Error al generar el PDF: ' + error.message, 'error');
            } finally {
                mostrarLoading(false);
            }
        }

async function generarPDF(data) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    try {
        const pageWidth = pdf.internal.pageSize.getWidth(), pageHeight = pdf.internal.pageSize.getHeight(), margin = 15;
        const textColor = '#000000', gray = '#6b7280', navy = '#0d2c54', lightGray = '#f5f5f5';
        const formatearNumero = (num) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num).replace('MX', '').trim();
        const colX = { desc: margin, unidad: margin + 90, cant: margin + 110, precio: margin + 130, total: margin + 160 };
        let page = 1, y = 20;
        const nuevaPagina = () => { pdf.addPage(); page++; y = 20; };
        const piePagina = () => pdf.setFontSize(8).setTextColor(gray).text(`Cotizaci√≥n No. ${data.cotizacionNumero} | P√°gina ${page}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        
        // MAPA PARA TRADUCIR CATEGOR√çAS CORTAS (incluye la correcci√≥n para 'AI')
        const categoriaDisplayMap = {
            'CCTV': 'üìπ CCTV',
            'DH': 'üè† DETECTOR DE HUMO',
            'CA': 'üîê CONTROL DE ACCESOS',
            'ALARMA INTRUSION': 'üö® ALARMA INTRUSI√ìN',
            'MULTIMEDIA': 'üì∫ MULTIMEDIA',
            'REDES': 'üõú REDES TRANSPORTE DE DATOS',
            'OTRO': 'üì¶ OTRO',
            'AI': 'üö® ALARMA INTRUSI√ìN', 
            'ALARMA': 'üö® ALARMA INTRUSI√ìN' 
        };

        try { pdf.addImage('../css/img/Logo-RSI-OFICIAL.png', 'PNG', pageWidth - margin - 40, margin, 40, 40); } catch (e) { console.warn('No se pudo cargar el logo.'); }
        pdf.setFontSize(10).setTextColor(navy).text(data.empresaNombre || "RSI ENTERPRISE", margin, y + 5);
        pdf.setFontSize(8).setTextColor(gray).text(data.empresaDireccion || "", margin, y + 10).text(`RFC: ${data.empresaRFC || ''} | Tel: ${data.empresaTelefono || ''}`, margin, y + 15);
        y += 25;
        pdf.setFontSize(14).setTextColor(navy).text("COTIZACI√ìN", pageWidth / 2, y, { align: 'center' });
        pdf.setFontSize(9).setTextColor(gray).text(`No. ${data.cotizacionNumero} | Fecha: ${new Date(data.cotizacionFecha).toLocaleDateString('es-MX')}`, pageWidth / 2, y + 7, { align: 'center' });
        y += 20;

        // ==========================================================
        //  ‚¨áÔ∏è NUEVA L√ìGICA PARA A√ëADIR LA DESCRIPCI√ìN (cotizacionDescripcion)
        // ==========================================================
        if (data.cotizacionDescripcion && data.cotizacionDescripcion.trim().length > 0) {
            pdf.setFontSize(9).setTextColor(navy).setFont('helvetica', 'bold').text("DESCRIPCI√ìN:", margin, y);
            y += 5;
            pdf.setFontSize(9).setTextColor(textColor).setFont('helvetica', 'normal');
            
            // Usar splitTextToSize para manejar saltos de l√≠nea si la descripci√≥n es larga
            const descLines = pdf.splitTextToSize(data.cotizacionDescripcion.trim(), pageWidth - 2 * margin);
            descLines.forEach(line => {
                pdf.text(line, margin, y); 
                y += 5;
            });
            y += 5; // Espacio extra despu√©s de la descripci√≥n
        }
        // ==========================================================
        
        pdf.setFontSize(9).setTextColor(textColor).text(`Cliente: ${data.clienteNombre}`, margin, y); y += 5;
        pdf.text(`RFC: ${data.clienteRFC || 'N/E'}`, margin, y); y += 5; pdf.text(`Direcci√≥n: ${data.clienteDireccion}`, margin, y); y += 10;
        const tipoCotizacionMap = { 'implementacion': 'Implementaci√≥n', 'proyecto': 'Proyecto', 'servicio': 'Servicio' };
        let infoPago = `Pago: ${data.tipoCredito || 'N/E'}`;
        if (data.tipoCredito === 'credito' && data.diasCredito) infoPago += ` (${data.diasCredito} d√≠as)`;
        const info = [`Tipo: ${tipoCotizacionMap[data.tipoCotizacion] || 'N/E'}`, `Vigencia: ${data.cotizacionVigencia} d√≠as`, `Moneda: ${data.cotizacionMoneda}`, infoPago].join(" | ");
        pdf.text(info, margin, y); y += 10;
        
        const grupos = agruparTecnologias(data.items);
        Object.entries(grupos).forEach(([categoria, items]) => {
            // Aplicar la traducci√≥n para mostrar el nombre completo.
            const textoCompleto = categoriaDisplayMap[categoria] || categoria;
            // Limpiar de emoji y espacio para el PDF, ya que la fuente puede fallar.
            const displayCategoria = textoCompleto.replace(/^(.*?)\s/, '').trim(); 

            if (y > pageHeight - 70) { piePagina(); nuevaPagina(); }
            pdf.setFillColor(navy).rect(margin, y, pageWidth - 2 * margin, 12, 'F');
            // Usamos displayCategoria que ya fue traducida y limpiada.
            pdf.setFontSize(12).setTextColor('#FFFFFF').setFont('helvetica', 'bold').text(displayCategoria, pageWidth / 2, y + 8, { align: 'center' });
            y += 14;
            pdf.setFillColor(navy).rect(margin, y, pageWidth - 2 * margin, 8, 'F');
            pdf.setFontSize(8).setFont('helvetica', 'normal').text("DESCRIPCI√ìN", colX.desc, y + 5).text("UNIDAD", colX.unidad, y + 5, { align: 'center' }).text("CANT.", colX.cant, y + 5, { align: 'right' }).text("P. UNIT.", colX.precio, y + 5, { align: 'right' }).text("TOTAL", colX.total, y + 5, { align: 'right' });
            y += 10;
            items.forEach((item, index) => {
                const descLines = pdf.splitTextToSize(item.descripcion, colX.unidad - colX.desc - 5);
                const itemHeight = Math.max(descLines.length * 5, 10) + 2;
                if (y + itemHeight > pageHeight - 20) { piePagina(); nuevaPagina(); }
                if (index % 2 === 0) pdf.setFillColor(lightGray).rect(margin, y, pageWidth - 2 * margin, itemHeight, 'F');
                pdf.setTextColor(textColor);
                descLines.forEach((line, i) => pdf.text(line, colX.desc, y + 5 + (i * 5)));
                pdf.text(item.tipoTecnologia.slice(0, 4), colX.unidad, y + 5, { align: 'center' });
                pdf.text(item.cantidad.toString(), colX.cant, y + 5, { align: 'right' });
                pdf.text(formatearNumero(item.precio), colX.precio, y + 5, { align: 'right' });
                pdf.text(formatearNumero(item.total), colX.total, y + 5, { align: 'right' });
                pdf.setDrawColor(200, 200, 200).line(margin, y + itemHeight, pageWidth - margin, y + itemHeight);
                y += itemHeight;
            });
            y += 2;
        });
        
        // Totales y T√©rminos (sin cambios)
        const tableStartX = colX.total - 82, valueColX = tableStartX + 70;
        pdf.setFontSize(9).setTextColor(textColor).text("Subtotal:", tableStartX, y + 5, { align: 'left' }).text(formatearNumero(data.subtotal), valueColX, y + 5, { align: 'left' }); y += 5;
        if (data.descuentoMonto > 0) { pdf.text(`Descuento (${data.descuento}%):`, tableStartX, y + 5, { align: 'left' }).text(`-${formatearNumero(data.descuentoMonto)}`, valueColX, y + 5, { align: 'left' }); y += 5; }
        pdf.text(`IVA (${data.impuesto}%):`, tableStartX, y + 5, { align: 'left' }).text(formatearNumero(data.impuestoMonto), valueColX, y + 5, { align: 'left' }); y += 7;
        pdf.setFont('helvetica', 'bold').setTextColor(navy).text("TOTAL:", tableStartX, y + 5, { align: 'left' }).text(`${formatearNumero(data.totalFinal)} ${data.cotizacionMoneda}`, valueColX, y + 5, { align: 'left' });
        if (data.terminos) {
            y += 20;
            if (y > pageHeight - 50) { piePagina(); nuevaPagina(); }
            pdf.setFontSize(9).setTextColor(navy).setFont('helvetica', 'normal').text("T√âRMINOS Y CONDICIONES", margin, y); y += 5;
            pdf.setTextColor(textColor);
            data.terminos.split('\n').forEach(term => {
                if (term.trim()) pdf.splitTextToSize(term, pageWidth - 2 * margin).forEach(line => {
                    if (y > pageHeight - 20) { piePagina(); nuevaPagina(); }
                    pdf.text(line, margin, y); y += 5;
                });
            });
        }
        piePagina();
        return pdf.output('blob');
    } catch (error) { console.error('Error en generarPDF:', error); throw new Error('Error al generar PDF'); }
}


async function cargarCotizaciones() {
    try {
        const q = query(collection(db, 'cotizacionPdf'), orderBy('fechaCreacion', 'desc'));
        const querySnapshot = await getDocs(q);
        cotizaciones = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        filteredCotizaciones = [...cotizaciones];
        currentPage = 1;
        renderizarTablaCotizaciones();
    } catch (error) {
        console.error('Error al cargar cotizaciones:', error);
        mostrarAlerta('‚ùå Error al cargar cotizaciones', 'error');
    }
}

function filtrarCotizaciones() {
    const filtro = buscarInput.value.toLowerCase().trim();
    filteredCotizaciones = filtro ? cotizaciones.filter(c => 
        (c.cotizacionNumero || '').toLowerCase().includes(filtro) || 
        (c.clienteNombre || '').toLowerCase().includes(filtro) ||
        (c.cotizacionDescripcion || '').toLowerCase().includes(filtro)
    ) : [...cotizaciones];
    currentPage = 1;
    renderizarTablaCotizaciones();
}

function setupPagination() {
    const paginationContainer = document.getElementById('pagination-controls');
    paginationContainer.innerHTML = '';
    const pageCount = Math.ceil(filteredCotizaciones.length / rowsPerPage);
    if (pageCount <= 1) return;
    const createButton = (text, onClick, disabled = false) => {
        const button = document.createElement('button');
        button.className = 'pagination-button';
        button.innerText = text;
        button.disabled = disabled;
        button.addEventListener('click', onClick);
        return button;
    };
    paginationContainer.appendChild(createButton('Anterior', () => { if (currentPage > 1) { currentPage--; renderizarTablaCotizaciones(); } }, currentPage === 1));
    for (let i = 1; i <= pageCount; i++) {
        const pageButton = createButton(i, () => { currentPage = i; renderizarTablaCotizaciones(); });
        if (i === currentPage) pageButton.classList.add('active');
        paginationContainer.appendChild(pageButton);
    }
    paginationContainer.appendChild(createButton('Siguiente', () => { if (currentPage < pageCount) { currentPage++; renderizarTablaCotizaciones(); } }, currentPage === pageCount));
}

function renderizarTablaCotizaciones() {
    cotizacionesTableBody.innerHTML = '';
    const startIndex = (currentPage - 1) * rowsPerPage;
    const paginatedItems = filteredCotizaciones.slice(startIndex, startIndex + rowsPerPage);

    if (paginatedItems.length === 0) {
        cotizacionesTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">No se encontraron cotizaciones.</td></tr>`;
        setupPagination();
        return;
    }

    paginatedItems.forEach(coti => {
        const estatusInfo = {
            'vendida': { color: '#22c55e', textoBase: '‚úÖ Vendida' },
            'en proceso': { color: '#f59e0b', textoBase: '‚è≥ En Proceso' },
            'rechazada': { color: '#ef4444', textoBase: '‚ùå Rechazada' }
        };
        const estatusActual = coti.estatus || 'en proceso';
        const info = estatusInfo[estatusActual];
        let textoCompleto = info.textoBase;
        if (estatusActual === 'vendida') textoCompleto += ` - ${coti.pagoEstatus === 'pagada' ? 'Pagada' : 'Pendiente'}`;
        else if (estatusActual === 'rechazada' && coti.motivoRechazo) textoCompleto += `: ${coti.motivoRechazo}`;
        
        const row = document.createElement('tr');
        row.style.borderLeft = `5px solid ${info.color}`;
        row.innerHTML = `
            <td><strong>${coti.cotizacionNumero}</strong></td>
            <td>${coti.clienteNombre}</td>
            <td>${new Date(coti.cotizacionFecha).toLocaleDateString('es-MX')}</td>
            <td><strong>${formatearMoneda(coti.totalFinal)}</strong></td>
            <td>${coti.cotizacionDescripcion || 'N/A'}</td>
            <td><small>${coti.generadoPor?.nombre || 'N/A'}</small></td>
            <td>
                <div class="estatus-container" style="background-color: ${info.color}1A; border: 1px solid ${info.color}; padding: 8px; border-radius: 8px;">
                    <span style="color: ${info.color}; font-weight: bold; font-size: 0.8rem;">${textoCompleto}</span>
                    <select class="estatus-select" data-id="${coti.id}" style="width:100%;"><option value="en proceso" ${estatusActual === 'en proceso' ? 'selected' : ''}>En Proceso</option><option value="vendida" ${estatusActual === 'vendida' ? 'selected' : ''}>Vendida</option><option value="rechazada" ${estatusActual === 'rechazada' ? 'selected' : ''}>Rechazada</option></select>
                    <div class="additional-status-fields ${estatusActual === 'vendida' ? 'show' : ''}"><select class="pago-estatus-select" data-id="${coti.id}" style="width:100%;"><option value="pendiente" ${coti.pagoEstatus === 'pendiente' ? 'selected' : ''}>Pendiente</option><option value="pagada" ${coti.pagoEstatus === 'pagada' ? 'selected' : ''}>Pagada</option></select></div>
                    <div class="additional-status-fields ${estatusActual === 'rechazada' ? 'show' : ''}"><textarea class="motivo-rechazo-input" data-id="${coti.id}" placeholder="Motivo..." style="width:100%;">${coti.motivoRechazo || ''}</textarea></div>
                </div>
            </td>
            <td class="acciones">
                <button class="btn btn-small btn-primary ver-pdf" data-id="${coti.id}"><span>üëÅÔ∏è</span></button>
                <button class="btn btn-small btn-success descargar-pdf" data-id="${coti.id}"><span>‚¨áÔ∏è</span></button>
                <button class="btn btn-small btn-secondary editar-cotizacion" data-id="${coti.id}"><span>‚úèÔ∏è</span></button>
                <button class="btn btn-small btn-danger eliminar-cotizacion" data-id="${coti.id}"><span>üóëÔ∏è</span></button>
            </td>
        `;
        cotizacionesTableBody.appendChild(row);
    });
    
    cotizacionesTableBody.querySelectorAll('.ver-pdf').forEach(btn => btn.addEventListener('click', (e) => verPDF(e.currentTarget.dataset.id)));
    cotizacionesTableBody.querySelectorAll('.descargar-pdf').forEach(btn => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        const cotizacion = cotizaciones.find(c => c.id === id);
        if (cotizacion) {
            mostrarLoading(true);
            try {
                const pdfBlob = await generarPDF(cotizacion);
                descargarPDFLocal(pdfBlob, `cotizacion-${cotizacion.cotizacionNumero}.pdf`);
            } catch (error) { mostrarAlerta('Error al descargar PDF', 'error'); }
            finally { mostrarLoading(false); }
        }
    }));
    cotizacionesTableBody.querySelectorAll('.editar-cotizacion').forEach(btn => btn.addEventListener('click', (e) => editarCotizacion(e.currentTarget.dataset.id)));
    cotizacionesTableBody.querySelectorAll('.eliminar-cotizacion').forEach(btn => btn.addEventListener('click', (e) => confirmarEliminacion(e.currentTarget.dataset.id)));
    
    cotizacionesTableBody.querySelectorAll('.estatus-select').forEach(select => select.addEventListener('change', (e) => {
        const id = e.target.dataset.id;
        const nuevoEstatus = e.target.value;
        const vendidaDiv = e.target.nextElementSibling;
        const rechazadaDiv = e.target.nextElementSibling.nextElementSibling;
        vendidaDiv.classList.toggle('show', nuevoEstatus === 'vendida');
        rechazadaDiv.classList.toggle('show', nuevoEstatus === 'rechazada');
        actualizarEstatusCotizacion(id, { estatus: nuevoEstatus });
    }));
    cotizacionesTableBody.querySelectorAll('.pago-estatus-select').forEach(select => select.addEventListener('change', (e) => actualizarEstatusCotizacion(e.target.dataset.id, { pagoEstatus: e.target.value })));
    cotizacionesTableBody.querySelectorAll('.motivo-rechazo-input').forEach(textarea => textarea.addEventListener('blur', (e) => actualizarEstatusCotizacion(e.target.dataset.id, { motivoRechazo: e.target.value })));

    setupPagination();
}
    
async function actualizarEstatusCotizacion(id, dataToUpdate) {
    try {
        mostrarLoading(true);
        if (dataToUpdate.estatus) {
            if (dataToUpdate.estatus !== 'vendida') dataToUpdate.pagoEstatus = '';
            if (dataToUpdate.estatus !== 'rechazada') dataToUpdate.motivoRechazo = '';
        }
        await updateDoc(doc(db, 'cotizacionPdf', id), dataToUpdate);
        await cargarCotizaciones(); // Recarga todo para asegurar consistencia
        mostrarAlerta('‚úÖ Estatus actualizado', 'success');
    } catch (error) {
        console.error('Error al actualizar estatus:', error);
        mostrarAlerta('‚ùå Error al actualizar', 'error');
    } finally {
        mostrarLoading(false);
    }
}

async function editarCotizacion(id) {
    const cotizacion = cotizaciones.find(c => c.id === id);
    if (!cotizacion) return;
    resetearFormulario();
    isEditing = true;
    editingId = id;
    modalTitle.textContent = '‚úèÔ∏è Editar Cotizaci√≥n';
    cotizacionForm.querySelector('button[type="submit"]').innerHTML = '<span>üíæ</span> Actualizar Cotizaci√≥n PDF';
    Object.keys(cotizacion).forEach(key => {
        const input = document.querySelector(`[name="${key}"]`);
        if (input) input.value = cotizacion[key];
    });
    empresaSelector.value = cotizacion.empresaNombre?.includes('NEZA') ? 'RSI NEZA' : 'RSI IXT';
    handleEmpresaChange();
    if (cotizacion.esEntradaManual) {
        activarEntradaManual();
        clienteNombre.value = cotizacion.clienteNombre;
        clienteRFC.value = cotizacion.clienteRFC;
        clienteDireccion.value = cotizacion.clienteDireccion;
        clienteTelefono.value = cotizacion.clienteTelefono;
    } else {
        const clienteEncontrado = clientes.find(c => c.nombre === cotizacion.clienteNombre);
        if (clienteEncontrado) seleccionarCliente(clienteEncontrado);
    }
    itemsTableBody.innerHTML = '';
    if (cotizacion.items?.length > 0) {
        cotizacion.items.forEach(item => {
            agregarItem();
            const lastRow = itemsTableBody.lastElementChild;
            lastRow.querySelector('.item-categoria').value = item.categoria || '';
            lastRow.querySelector('.item-tipo-tecnologia').value = item.tipoTecnologia || '';
            lastRow.querySelector('.item-descripcion').value = item.descripcion;
            lastRow.querySelector('.item-cantidad').value = item.cantidad;
            lastRow.querySelector('.item-precio').value = item.precio;
            calcularTotalItem(lastRow);
        });
    } else {
        agregarItem();
    }
    calcularTotales();
    modalCotizacion.classList.add('show');
}

function confirmarEliminacion(id) {
    const cotizacion = cotizaciones.find(c => c.id === id);
    if (!cotizacion) return;
    Swal.fire({
        title: '¬øEst√°s seguro?',
        text: `Se eliminar√° la cotizaci√≥n ${cotizacion.cotizacionNumero}.`,
        icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
        confirmButtonText: 'S√≠, eliminar', cancelButtonText: 'Cancelar'
    }).then((result) => { if (result.isConfirmed) eliminarCotizacion(id); });
}

async function eliminarCotizacion(id) {
    try {
        mostrarLoading(true);
        await deleteDoc(doc(db, 'cotizacionPdf', id));
        Swal.fire('¬°Eliminada!', 'La cotizaci√≥n ha sido eliminada.', 'success');
        await cargarCotizaciones();
    } catch (error) {
        console.error('Error al eliminar:', error);
        Swal.fire('Error', 'No se pudo eliminar la cotizaci√≥n.', 'error');
    } finally {
        mostrarLoading(false);
    }
}

function mostrarLoading(mostrar) { loadingSpinner.style.display = mostrar ? 'flex' : 'none'; }
function mostrarAlerta(mensaje, tipo = 'info') {
    Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true })
    .fire({ icon: tipo, title: mensaje });
}

function mostrarModalResumen() {
    modalResumenCuentas.classList.add('show');
    const defaultFilterBtn = resumenFiltrosContainer.querySelector('[data-filtro="todos"]');
    setActiveFilter(defaultFilterBtn);
    calcularYMostrarResumen('todos');
}

function handleFiltroClick(e) {
    if (e.target.classList.contains('btn-filtro')) {
        const filtro = e.target.dataset.filtro;
        setActiveFilter(e.target);
        calcularYMostrarResumen(filtro);
    }
}

function setActiveFilter(activeButton) {
    resumenFiltrosContainer.querySelectorAll('.btn-filtro').forEach(btn => btn.classList.remove('active'));
    activeButton.classList.add('active');
}

function calcularYMostrarResumen(filtro = 'todos') {
    const cotizacionesFiltradas = (filtro === 'todos') ? cotizaciones : cotizaciones.filter(c => c.estatus === filtro);
    const sumaTotal = cotizacionesFiltradas.reduce((total, coti) => total + (coti.totalFinal || 0), 0);
    const titulos = {
        'todos': 'Total de Todas las Cotizaciones',
        'en proceso': 'Total de Cotizaciones "En Proceso"',
        'vendida': 'Total de Cotizaciones "Vendidas"',
        'rechazada': 'Total de Cotizaciones "Rechazadas"'
    };
    document.getElementById('resumenTitulo').textContent = titulos[filtro];
    document.getElementById('resumenSumaTotal').textContent = formatearMoneda(sumaTotal);
}

    </script>
</body>
</html>