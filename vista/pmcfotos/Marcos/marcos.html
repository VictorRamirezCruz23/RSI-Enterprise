<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Gallery - PMC</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="stylesheet" href="../../Vista/css/admin.css">
    <link rel="stylesheet" href="../../Vista/css/nan.css">
<link rel="stylesheet" href="marcos.css">
   
</head>
<body>
<nav>
    <div class="logo">PMC ADMIN</div>
    <div class="nav-links">
        <a href="../Admin/dashadmin.html">Admin Home</a>
    </div>
</nav>

    <div class="background-gradient"></div>
    
    <div class="admin-panel">
        <h2>Admin of Gallery ("Marcos")</h2>
        
        <button id="toggleFormBtn" class="btn btn-primary add-service-btn">+ Add New Gallery</button>
        
        <div id="formModal" class="form-modal">
            <div class="form-modal-content">
                <span class="close-form-modal">&times;</span>
                <form id="galleryForm">
                    <div class="top-action-buttons">
                        <button type="submit" class="btn btn-primary" id="modalSubmitBtn">Save Gallery</button>
                    </div>
                    <div class="form-group">
                        <label for="galleryImage">Add Images (PNGs with transparency are supported)</label>
                        <input type="file" id="galleryImage" name="galleryImage" accept="image/*" multiple>
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="gallery-items-list">
            <h3>Registered Galleries</h3>
            <div class="gallery-items-container" id="galleriesContainer"></div>
        </div>
    </div>

    <div id="imagePreviewModal" class="preview-modal">
        <span class="close-preview" onclick="closePreview()">&times;</span>
        <img class="preview-modal-content" id="modalImage">
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC9wGk3OrHjlX6PWX5eEg8sQYMIB46puYo",
            authDomain: "pmcentertainment-899a1.firebaseapp.com",
            databaseURL: "https://pmcentertainment-899a1-default-rtdb.firebaseio.com",
            projectId: "pmcentertainment-899a1",
            storageBucket: "pmcentertainment-899a1.appspot.com",
            messagingSenderId: "308546493456",
            appId: "1:308546493456:web:fc219997646bc67027fe95"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const marcosRef = db.collection('Marcos');

        const MAX_IMAGE_WIDTH = 800;
        const MAX_IMAGE_HEIGHT = 800;
        const MAX_IMAGE_SIZE_KB = 125;
        const IMAGE_QUALITY = 0.7;
        const MAX_IMAGES = 15;

        let currentImages = [];

        const toggleFormBtn = document.getElementById('toggleFormBtn');
        const formModal = document.getElementById('formModal');
        const galleryForm = document.getElementById('galleryForm');
        const galleryImageInput = document.getElementById('galleryImage');
        const imagePreviewDiv = document.getElementById('imagePreview');
        const galleriesContainer = document.getElementById('galleriesContainer');
        const closeFormModalBtn = document.querySelector('.close-form-modal');
        const previewModal = document.getElementById('imagePreviewModal');

        toggleFormBtn.addEventListener('click', showFormModal);
        galleryForm.addEventListener('submit', handleFormSubmit);
        galleryImageInput.addEventListener('change', handleImageUpload);
        closeFormModalBtn.addEventListener('click', closeFormModal);
        
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                closePreview();
            }
        });

        window.addEventListener('DOMContentLoaded', loadGalleries);

        function showFormModal() {
            resetForm();
            formModal.style.display = 'block';
        }

        function closeFormModal() {
            resetForm();
            formModal.style.display = 'none';
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (currentImages.length === 0) {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Please select at least one image.' });
                return;
            }
            const galleryData = {
                images: currentImages,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            try {
                await marcosRef.add(galleryData);
                Swal.fire({ icon: 'success', title: 'Created', text: 'Gallery saved successfully!' });
                resetForm();
                loadGalleries();
                formModal.style.display = 'none';
            } catch (error) {
                console.error('Error saving gallery:', error);
                Swal.fire('Error', error.message || 'An unexpected error occurred', 'error');
            }
        }

        async function handleImageUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            if (files.length + currentImages.length > MAX_IMAGES) {
                Swal.fire('Limit exceeded', `Maximum ${MAX_IMAGES} images allowed.`, 'error');
                return;
            }
            for (const file of Array.from(files)) {
                if (!file.type.match('image.*')) continue;
                try {
                    const compressedDataUrl = await compressImage(file);
                    currentImages.push(compressedDataUrl);
                } catch (error) {
                    console.error(error);
                    Swal.fire('Compression Error', `Could not process ${file.name}. It might be too large.`, 'error');
                }
            }
            showImagePreviews();
            galleryImageInput.value = '';
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const isPng = file.type === 'image/png';
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_IMAGE_WIDTH) { height *= MAX_IMAGE_WIDTH / width; width = MAX_IMAGE_WIDTH; }
                        } else {
                            if (height > MAX_IMAGE_HEIGHT) { width *= MAX_IMAGE_HEIGHT / height; height = MAX_IMAGE_HEIGHT; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        if (isPng) {
                            resolve(canvas.toDataURL('image/png'));
                        } else {
                            let quality = IMAGE_QUALITY;
                            let dataUrl = canvas.toDataURL('image/jpeg', quality);
                            while (dataUrl.length / 1024 > MAX_IMAGE_SIZE_KB && quality > 0.1) {
                                quality -= 0.1;
                                dataUrl = canvas.toDataURL('image/jpeg', quality);
                            }
                            if (dataUrl.length / 1024 > MAX_IMAGE_SIZE_KB) {
                               return reject(`Could not compress ${file.name} enough.`);
                            }
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function showImagePreviews() {
            imagePreviewDiv.innerHTML = currentImages.map((imageSrc, index) => `
                <div class="preview-item">
                    <img src="${imageSrc}" alt="Preview ${index + 1}">
                    <button type="button" class="remove-image" onclick="removeImage(${index})">Ã—</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            showImagePreviews();
        }

        async function loadGalleries() {
            try {
                const snapshot = await marcosRef.orderBy('createdAt', 'desc').get();
                galleriesContainer.innerHTML = '';
                if (snapshot.empty) {
                    galleriesContainer.innerHTML = '<p>No registered galleries</p>';
                    return;
                }
                snapshot.forEach(doc => displayGallery(doc.data(), doc.id));
            } catch (error) {
                console.error('Error loading galleries:', error);
                Swal.fire('Load error', 'Could not load the galleries.', 'error');
            }
        }

        function displayGallery(gallery, docId) {
            const galleryCard = document.createElement('div');
            galleryCard.className = 'gallery-card';
            
            const imagesHTML = gallery.images.map(imgSrc => 
                `<img src="${imgSrc}" alt="Gallery Image" onclick="openPreview('${imgSrc}')">`
            ).join('');

            galleryCard.innerHTML = `
                <h4>Gallery ID: ${docId}</h4>
                <div class="gallery-images-container">${imagesHTML}</div>
                <div class="gallery-actions">
                    <button class="btn btn-danger" onclick="showDeleteModal('${docId}')">Delete</button>
                </div>
            `;
            galleriesContainer.appendChild(galleryCard);
        }

        async function showDeleteModal(docId) {
            const result = await Swal.fire({
                title: 'Delete this gallery?', text: 'This action cannot be undone.', icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!', cancelButtonText: 'Cancel'
            });
            if (result.isConfirmed) {
                try {
                    await marcosRef.doc(docId).delete();
                    Swal.fire('Deleted!', 'The gallery has been deleted.', 'success');
                    loadGalleries();
                } catch (error) {
                    console.error('Error deleting gallery:', error);
                    Swal.fire('Error', 'Could not delete the gallery.', 'error');
                }
            }
        }

        function resetForm() {
            galleryForm.reset();
            currentImages = [];
            imagePreviewDiv.innerHTML = '';
        }

        function openPreview(src) {
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            previewModal.style.display = 'flex'; // Cambia a 'flex' para mostrar y centrar
        }

        function closePreview() {
            previewModal.style.display = 'none';
        }

        // Global functions for buttons
        window.showDeleteModal = showDeleteModal;
        window.removeImage = removeImage;
    </script>
</body>
</html>