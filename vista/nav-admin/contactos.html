<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/navAdmin.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <title>RSI Enterprise - Contact Manager</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.all.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.min.css" />
  <style>
    body { 
        font-family: 'Arial', sans-serif; 
        background-color: #000000; 
        margin: 0;
        padding: 20px;
        color: #ffffff;
    }
    
    .comContainer { 
        background: #1a1a1a; 
        padding: 2rem; 
        border-radius: 15px; 
        box-shadow: 0 0 15px #ffffff1a; 
        max-width: 1200px; 
        margin: 0 auto; 
    }
    
    #comOpiniones {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
        padding: 25px 0;
    }
    
    .comOpinion { 
        background: #2d2d2d; 
        padding: 1.8rem; 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); 
        transition: all 0.3s ease;
        position: relative;
        color: #ffffff;
        border: 1px solid #3d3d3d;
    }
    
    .comOpinion:hover { 
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.7); 
    }
    
    .comFecha {
        color: #a0a0a0;
        font-size: 0.9rem;
        margin-top: 15px;
        font-style: italic;
    }
    
    .comEliminar {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 10px;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        top: 15px;
        right: 15px;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .comEliminar:hover {
        background: #ff1a1a;
        transform: scale(1.15);
        box-shadow: 0 0 12px rgba(220, 53, 69, 0.6);
    }
    
    .cargando, .error { 
        padding: 1.2rem; 
        margin: 2rem 0; 
        border-radius: 8px; 
        text-align: center;
    }
    
    .cargando { 
        background: #2d3748; 
        color: #a0aec0; 
        border: 1px solid #4a5568;
    }
    
    .error { 
        background: #4a1c1c; 
        color: #feb2b2; 
        border: 1px solid #742a2a;
    }
    
    h2 {
        color: #ffffff;
        border-bottom: 2px solid #3d3d3d;
        padding-bottom: 15px;
        margin-bottom: 25px;
        font-size: 2.2rem;
    }
    
    .comEstado {
        margin-top: 15px;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .comEstado.sin-contestar {
        background: #dc3545;
        color: white;
    }
    
    .comEstado.contestado {
        background: #28a745;
        color: white;
    }
    
    .comEstado select {
        background: transparent;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        margin-left: 8px;
    }
    
    .comEstado select option {
        background: #2d2d2d;
        color: white;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 30px;
        padding: 15px;
        background: #1a1a1a;
        border-radius: 10px;
    }

    .pagination button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background: #2d2d2d;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .pagination button:hover:not(:disabled) {
        background: #3d3d3d;
        transform: translateY(-2px);
    }

    .pagination button:disabled {
        background: #1a1a1a;
        color: #5a5a5a;
        cursor: not-allowed;
    }

    #paginaActual {
        font-weight: bold;
        color: #ffffff;
    }
  </style>
</head>
<body>
  <header class="header">
    <header class="nan_header">
      <nav class="nan_navbar">
          <div class="nan_logo">
              <img src="../css/img/LOGO BLANCO.png" alt="Logo">
          </div>
          <button class="nan_hamburger" aria-label="Abrir men√∫">&#9776;</button>
          <button class="nan_close" aria-label="Cerrar men√∫" style="display: none;">&times;</button>
          <ul class="nan_menu">
            <li><i class="fas fa-home"></i><a href="dashAdmin.html"> Inicio</a></li>&emsp; &emsp;&emsp; &emsp;&emsp; &emsp;&emsp; &emsp;
          </ul>
      </nav>
    </header>
  </header>
  <br><br><br><br>

  <div class="comContainer">
    <h2>üìù Mensajes de Contacto</h2>
    <div id="comOpiniones"></div>
    <div class="pagination">
      <button id="btnAnterior" disabled>‚Üê Anterior</button>
      <span id="paginaActual">P√°gina 1</span>
      <button id="btnSiguiente" disabled>‚Üí Siguiente</button>
    </div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
        getFirestore, collection, getDocs, 
        query, orderBy, doc, deleteDoc, 
        updateDoc, limit, startAfter
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Configuraci√≥n Firebase (REMPLAZAR CON TUS DATOS)
    const firebaseConfig = {
        apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
        authDomain: "rsienterprise.firebaseapp.com",
        projectId: "rsienterprise",
        storageBucket: "rsienterprise.appspot.com",
        messagingSenderId: "1063117165770",
        appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables de paginaci√≥n
    let currentPage = 1;
    let lastVisible = null;
    let firstVisible = null;
    let prevStack = [];

    // Funci√≥n de seguridad HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Test de conexi√≥n
    const testConnection = async () => {
        try {
            const testDoc = await getDocs(collection(db, "contactanos"));
            console.log("[DEBUG] Conexi√≥n exitosa. Documentos encontrados:", testDoc.size);
            if(testDoc.size > 0) {
                console.log("[DEBUG] Primer documento:", testDoc.docs[0].data());
            }
        } catch (error) {
            console.error("[DEBUG] Error de conexi√≥n:", error);
            Swal.fire({
                title: 'Error de conexi√≥n',
                html: `<div style="color:white;">
                    <p>Verifica:</p>
                    <ol>
                        <li>Las reglas de Firestore</li>
                        <li>La configuraci√≥n de Firebase</li>
                        <li>El nombre de la colecci√≥n</li>
                    </ol>
                    <code>${error.message}</code>
                </div>`,
                icon: 'error',
                background: '#2d2d2d',
                color: '#ffffff'
            });
        }
    };

    // Cargar contactos
    async function cargarContactos(direction = 'next') {
        const opinionesContainer = document.getElementById("comOpiniones");
        opinionesContainer.innerHTML = "<div class='cargando'>Cargando mensajes...</div>";
        
        try {
            let q;
            if (direction === 'next' && lastVisible) {
                q = query(
                    
                    collection(db, "contactanos"),
                    orderBy('fecha', 'desc'),
                    startAfter(lastVisible),
                    limit(6)
                );
            } else {
                q = query(
                    collection(db, "contactanos"),
                    orderBy('fecha', 'desc'),
                    limit(6)
                );
            }

            const querySnapshot = await getDocs(q);
            let contactosHTML = [];
            
            if (querySnapshot.empty) {
                opinionesContainer.innerHTML = "<p class='cargando'>No hay m√°s mensajes</p>";
                return;
            }

            // Almacenar referencia para paginaci√≥n
            lastVisible = querySnapshot.docs[querySnapshot.docs.length-1];

            querySnapshot.forEach(doc => {
                const data = doc.data();
                const estado = data.estado || "Sin contestar";
                const telefono = data.telefono || 'No proporcionado';
                
                contactosHTML.push(`
                    <div class="comOpinion">
                        <button class="comEliminar" data-id="${doc.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <p><strong>Nombre:</strong> ${escapeHtml(data.nombre)}</p>
                        <p><strong>Email:</strong> ${escapeHtml(data.email)}</p>
                        <p><strong>Tel√©fono:</strong> ${escapeHtml(telefono)}</p>
                        <p><strong>Mensaje:</strong> ${escapeHtml(data.mensaje)}</p>
                        <div class="comEstado ${estado.toLowerCase().replace(' ', '-')}">
                            Estado:
                            <select data-id="${doc.id}">
                                <option value="Sin contestar" ${estado === 'Sin contestar' ? 'selected' : ''}>Sin contestar</option>
                                <option value="Contestado" ${estado === 'Contestado' ? 'selected' : ''}>Contestado</option>
                            </select>
                        </div>
                        <p class="comFecha">${new Date(data.fecha.seconds * 1000).toLocaleDateString('es-ES', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                    </div>
                `);
            });

            opinionesContainer.innerHTML = contactosHTML.join('');

            // Actualizar controles de paginaci√≥n
            document.getElementById('paginaActual').textContent = `P√°gina ${currentPage}`;
            document.getElementById('btnAnterior').disabled = currentPage === 1;
            document.getElementById('btnSiguiente').disabled = querySnapshot.size < 5;

            configurarEventos();
            
        } catch (error) {
            console.error("Error cargando mensajes:", error);
            opinionesContainer.innerHTML = "<p class='error'>‚ö†Ô∏è Error cargando mensajes. Intenta recargar la p√°gina</p>";
        }
    }

    // Configurar eventos
    function configurarEventos() {
        // Eliminar
        document.querySelectorAll('.comEliminar').forEach(button => {
            button.addEventListener('click', async () => {
                const id = button.dataset.id;
                const result = await Swal.fire({
                    title: '¬øEliminar mensaje?',
                    text: 'Esta acci√≥n no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Eliminar',
                    cancelButtonText: 'Cancelar',
                    background: '#2d2d2d',
                    color: '#ffffff'
                });
                
                if (result.isConfirmed) {
                    try {
                        await deleteDoc(doc(db, "contactanos", id));
                        await cargarContactos();
                        Swal.fire({
                            title: 'Eliminado',
                            text: 'El mensaje ha sido eliminado',
                            icon: 'success',
                            background: '#2d2d2d',
                            color: '#ffffff'
                        });
                    } catch (error) {
                        console.error("Error eliminando mensaje:", error);
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo eliminar el mensaje',
                            icon: 'error',
                            background: '#2d2d2d',
                            color: '#ffffff'
                        });
                    }
                }
            });
        });

        // Cambiar estado
        document.querySelectorAll('.comEstado select').forEach(select => {
            select.addEventListener('change', async () => {
                const nuevoEstado = select.value;
                const id = select.dataset.id;
                
                try {
                    await updateDoc(doc(db, "contactanos", id), {
                        estado: nuevoEstado
                    });
                    
                    const estadoDiv = select.closest('.comEstado');
                    estadoDiv.className = `comEstado ${nuevoEstado.toLowerCase().replace(' ', '-')}`;
                    
                    Swal.fire({
                        title: 'Estado actualizado',
                        icon: 'success',
                        background: '#2d2d2d',
                        color: '#ffffff',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error("Error actualizando estado:", error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo actualizar el estado',
                        icon: 'error',
                        background: '#2d2d2d',
                        color: '#ffffff'
                    });
                }
            });
        });
    }

    // Eventos de paginaci√≥n
    document.getElementById('btnSiguiente').addEventListener('click', () => {
        currentPage++;
        cargarContactos('next');
    });

    document.getElementById('btnAnterior').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            cargarContactos('prev');
        }
    });

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
        testConnection();
        cargarContactos();
    });
</script>
</body>
</html>