<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Seguro con OpenPay BBVA | RSI Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Librería OpenPay JS -->
    <script type="text/javascript" src="https://resources.openpay.mx/lib/openpay-js/1.2.39/openpay.v1.min.js"></script>
    <link rel="stylesheet" href="https://rsienterprise.web.app/vista/css/styles.css">
    <link rel="stylesheet" href="https://rsienterprise.web.app/vista/css/estilos-nav.css">
    <link rel="stylesheet" href="https://rsienterprise.web.app/vista/css/pago.css">
    <style>
        /* Estilos optimizados para radio buttons compactos */
        .delivery-info {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1c1948;
        }
        
        .delivery-info p {
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }
        
        .branch-selection {
            margin-top: 15px;
        }
        
        .branch-option {
            margin-bottom: 10px;
            padding: 10px 15px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            align-items: flex-start;
            transition: all 0.3s ease;
        }
        
        .branch-option:hover {
            border-color: #1c1948;
            background-color: #f5f5ff;
        }
        
        .branch-option label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            width: 100%;
            margin: 0;
            gap: 8px;
        }
        
        .branch-option input[type="radio"] {
            width: 16px;
            height: 16px;
            min-width: 16px;
            min-height: 16px;
            margin: 3px 0 0 0;
            flex-shrink: 0;
        }
        
        .branch-content {
            flex-grow: 1;
        }
        
        .branch-title {
            font-weight: 600;
            color: #1c1948;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        .branch-details {
            font-size: 14px;
            color: #555;
            display: flex;
            align-items: center;
            line-height: 1.4;
        }
        
        .branch-details i {
            margin-right: 8px;
            color: #1c1948;
            min-width: 16px;
            text-align: center;
        }
    </style>
</head>
<body>
    <header class="nan_header">
        <nav class="nan_navbar">
            <div class="nan_logo">
                <a href="dashUser.html"><img src="../../../vista/css/img/Logo-RSI-OFICIAL.png" alt="Logo"></a>
            </div>
            <button class="nan_hamburger" aria-label="Abrir menú" aria-expanded="false">&#9776;</button>
            <button class="nan_close" aria-label="Cerrar menú" style="display: none;">&times;</button>
            <ul class="nan_menu">
                <li><a href="productos-usuario.html"><i class="fas fa-box"></i> Productos</a></li>
                <li><a href="historial-de-compras.html"><i class="fas fa-history"></i> Historial de compras</a></li>
                <li><a href="lista-de-deseos.html"><i class="fas fa-heart"></i> Lista de deseos</a></li>
                <li><a href="soporte.html"><i class="fas fa-headset"></i> Soporte</a></li>
                <li><a href="perfil.html"><i class="fas fa-user"></i> Mi perfil</a></li>
                <li><a href="#" id="cerrarSesion"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a></li>
                <li class="nan_language">
                    <select id="languageSelect" class="language-select">
                        <option value="es" data-flag="../css/img/flag-mexico.png">🇲🇽</option>
                        <option value="en" data-flag="../css/img/flag-usa.png">🇺🇸</option>
                    </select>
                </li>
            </ul>
        </nav>
    </header>
    
    <div class="payment-container">
        <div class="bank-logos">
            <img src="https://documents.openpay.mx/wp-content/uploads/2022/02/openpay-color.png" alt="OpenPay">
        </div>
        
        <div class="secure-payment-badge" style="justify-content: center; margin-bottom: 20px;">
            <i class="fas fa-lock"></i>
            <span>Pago seguro con Openpay de BBVA</span>
        </div>
        
        <div class="payment-header">
            <h1><i class="fas fa-credit-card"></i> Finalizar Compra</h1>
        </div>
        
        <div class="user-info">
            <button class="edit-info-btn" id="btn-edit-info">
                <i class="fas fa-edit"></i> Editar información
            </button>
            <h3><i class="fas fa-user"></i> Información del cliente</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Nombre completo</div>
                    <div class="info-value" id="user-name">Cargando...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Correo electrónico</div>
                    <div class="info-value" id="user-email">Cargando...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Teléfono</div>
                    <div class="info-value" id="user-phone">Cargando...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Dirección</div>
                    <div class="info-value" id="user-address">Cargando...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ciudad</div>
                    <div class="info-value" id="user-city">Cargando...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Código Postal</div>
                    <div class="info-value" id="user-zip">Cargando...</div>
                </div>
            </div>
        </div>
        
        <div class="cart-summary">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cart-items">
                    <!-- Los elementos del carrito se cargarán aquí -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="cart-total">Total:</td>
                        <td class="cart-total" id="cart-total">$0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="delivery-info">
            <p><i class="fas fa-info-circle"></i> <strong>Importante:</strong> Actualmente solo realizamos entregas en nuestras sucursales. Por favor selecciona la sucursal donde deseas recoger tu pedido:</p>
            
            <div class="branch-selection">
                <div class="branch-option">
                    <label>
                        <input type="radio" name="branch" value="Nezahualcoyotl" checked>
                        <div class="branch-content">
                            <div class="branch-title">Nezahualcoyotl, Estado de México</div>
                            <div class="branch-details">
                                <i class="fas fa-map-marker-alt"></i> C. 31 110, El Sol, 57200 Cdad. Nezahualcóyotl, Méx.
                            </div>
                        </div>
                    </label>
                </div>
                
                <div class="branch-option">
                    <label>
                        <input type="radio" name="branch" value="Ixtapaluca">
                        <div class="branch-content">
                            <div class="branch-title">Ixtapaluca, Estado de México</div>
                            <div class="branch-details">
                                <i class="fas fa-map-marker-alt"></i> 84PP+Q4F San Francisco Acuautla, Estado de México
                            </div>
                        </div>
                    </label>
                </div>
                
                <div class="branch-option">
                    <label>
                        <input type="radio" name="branch" value="California, Estados Unidos">
                        <div class="branch-content">
                            <div class="branch-title">California, Estados Unidos</div>
                            <div class="branch-details">
                                <i class="fas fa-map-marker-alt"></i> RAFHA RSI USA LLC, 2547 S Euclid Ave, Ontario, CA 91762, EE. UU.
                            </div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <button id="btn-proceed-payment" class="btn-pay" disabled>
            <i class="fas fa-lock"></i> Proceder al pago seguro
        </button>
        
        <div class="secure-payment-badge" style="justify-content: center; margin-top: 20px;">
            <i class="fas fa-shield-alt"></i>
            <span>Transacción segura con OpenPay BBVA</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="https://resources.openpay.mx/lib/openpay-js/1.2.39/openpay.v1.min.js"></script>
<script>
// Configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
    authDomain: "rsienterprise.firebaseapp.com",
    projectId: "rsienterprise",
    storageBucket: "rsienterprise.appspot.com",
    messagingSenderId: "1063117165770",
    appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
};

// Inicializar Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();

// Configuración de OpenPay
OpenPay.setId('mfxzk8dtsjsaqscngyxp');
OpenPay.setApiKey('pk_92a7dde47c53491a828e3edba6e2704c');
OpenPay.setSandboxMode(true);

// Variable para almacenar datos del usuario
let userData = {};

// Función para generar IDs de orden únicos
function generateOrderId(userId) {
    const date = new Date();
    const datePart = date.toISOString().split('T')[0].replace(/-/g, '');
    const timePart = date.getHours().toString().padStart(2, '0') + 
                     date.getMinutes().toString().padStart(2, '0');
    const userPart = userId.substring(0, 4).toUpperCase();
    const randomPart = Math.floor(1000 + Math.random() * 9000);
    
    return `RSI-${datePart}-${timePart}-${userPart}-${randomPart}`;
}

// Función para obtener el ID de la orden actual
function getCurrentOrderId() {
    return localStorage.getItem('currentOrderId') || 
           (JSON.parse(localStorage.getItem('currentOrder'))?.orderId || 
           null);
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            await loadUserData(user.uid);
            loadCart();
            document.getElementById('btn-proceed-payment').addEventListener('click', processPayment);
            
            // Mostrar order ID actual si existe (para depuración)
            const currentOrderId = getCurrentOrderId();
            if (currentOrderId) {
                console.log('Order ID existente:', currentOrderId);
            }
        } else {
            window.location.href = '/login';
        }
    });
});
 // Agregar el event listener para el botón de editar
            document.getElementById('btn-edit-info').addEventListener('click', function() {
                window.location.href = 'perfil.html';
            });
// Cargar datos del usuario
async function loadUserData(userId) {
    try {
        const doc = await db.collection('usuarios').doc(userId).get();
        if (doc.exists) {
            userData = doc.data();
            updateUserInfoUI();
            validateUserData();
        }
    } catch (error) {
        console.error("Error cargando datos:", error);
    }
}

// Actualizar UI con datos del usuario
function updateUserInfoUI() {
    const fields = {
        'user-name': 'nombreCompleto',
        'user-email': 'email',
        'user-phone': 'telefono',
        'user-address': 'direccion',
        'user-city': 'ciudad',
        'user-zip': 'codigoPostal'
    };
    
    for (const [id, field] of Object.entries(fields)) {
        const element = document.getElementById(id);
        if (element) element.textContent = userData[field] || 'No proporcionado';
    }
}

// Validar datos del usuario
function validateUserData() {
    const requiredFields = ['nombreCompleto', 'email', 'telefono', 'direccion', 'ciudad', 'codigoPostal'];
    const isComplete = requiredFields.every(field => userData[field]?.trim());
    
    const payButton = document.getElementById('btn-proceed-payment');
    if (payButton) payButton.disabled = !isComplete;
}

// Cargar y mostrar carrito
function loadCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const container = document.getElementById('cart-items');
    let total = 0;
    
    container.innerHTML = '';
    
    cart.forEach((item, index) => {
        const price = parseFloat(item.precio.toString().replace(/[^0-9.]/g, '')) || 0;
        const subtotal = price * item.cantidad;
        total += subtotal;
        
        const row = `
            <tr>
                <td class="cart-item-name">
                    <img src="${item.imagen || 'https://via.placeholder.com/50'}" alt="${item.nombre}" class="cart-item-image">
                    <span>${item.nombre}</span>
                </td>
                <td>$${price.toFixed(2)}</td>
                <td>
                    <div class="quantity-control">
                        <button onclick="updateQuantity(${index}, -1)">-</button>
                        <input type="number" value="${item.cantidad}" min="1" onchange="updateQuantityInput(${index}, this.value)">
                        <button onclick="updateQuantity(${index}, 1)">+</button>
                    </div>
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td><button onclick="removeItem(${index})"><i class="fas fa-trash"></i></button></td>
            </tr>
        `;
        container.innerHTML += row;
    });
    
    document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
}

// Funciones del carrito
function updateQuantity(index, change) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const newQty = cart[index].cantidad + change;
    if (newQty > 0) {
        cart[index].cantidad = newQty;
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
    }
}

function updateQuantityInput(index, value) {
    const newQty = parseInt(value);
    if (!isNaN(newQty) && newQty > 0) {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart[index].cantidad = newQty;
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
    }
}

function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCart();
}

// Procesar pago con OpenPay
async function processPayment() {
    const button = document.getElementById('btn-proceed-payment');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    
    try {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        if (cart.length === 0) throw new Error('El carrito está vacío');
        
        // Calcular total
        const total = cart.reduce((sum, item) => {
            const price = parseFloat(item.precio.toString().replace(/[^0-9.]/g, '')) || 0;
            return sum + (price * item.cantidad);
        }, 0);
        
        if (total <= 0) throw new Error('Total inválido');
        
        // Obtener sucursal seleccionada
        const branch = document.querySelector('input[name="branch"]:checked').value;
        
        // Generar ID de orden único
        const orderId = generateOrderId(auth.currentUser.uid);
        
        // GUARDAR EL ORDER ID EN LOCALSTORAGE (PRIMERA FORMA - DIRECTO)
        localStorage.setItem('currentOrderId', orderId);
        
        // Guardar información completa de la orden en localStorage (SEGUNDA FORMA - EN OBJETO)
        const orderInfo = {
            orderId: orderId,
            date: new Date().toISOString(),
            amount: total,
            branch: branch,
            items: cart,
            status: 'pending'
        };
        
        localStorage.setItem('currentOrder', JSON.stringify(orderInfo));
        
        // Crear objeto de orden para Firestore
        const orderData = {
            order_id: orderId,
            user_id: auth.currentUser.uid,
            user_email: userData.email,
            amount: total,
            status: 'pending',
            branch: branch,
            items: cart.map(item => ({
                id: item.id,
                name: item.nombre,
                price: item.precio,
                quantity: item.cantidad,
                image: item.imagen || ''
            })),
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            updated_at: firebase.firestore.FieldValue.serverTimestamp(),
            payment_status: 'pending',
            metadata: {
                cart_version: '1.0',
                localStorage_order_id: orderId
            }
        };

        // Guardar la orden en Firestore
        await db.collection('orders').doc(orderId).set(orderData);
        console.log('Orden registrada en Firestore:', orderId);
        console.log('Order ID guardado en localStorage:', localStorage.getItem('currentOrderId'));
        console.log('Order completo guardado en localStorage:', JSON.parse(localStorage.getItem('currentOrder')));

        // Preparar datos para OpenPay
        const nameParts = userData.nombreCompleto.split(' ');
        const firstName = nameParts[0] || userData.nombreCompleto;
        const lastName = nameParts.slice(1).join(' ') || "Cliente";
        
        const paymentData = {
            "amount": total.toFixed(2),
            "currency": "MXN",
            "description": `Compra en RSI Enterprise - ${branch}`,
            "order_id": orderId,
            "send_email": true,
            "redirect_url": "https://rsienterprise.com/vista/nav-usuarios/operacion-exitosa.html",
            "customer": {
                "name": firstName,
                "last_name": lastName,
                "email": userData.email,
                "phone_number": userData.telefono || "5555555555",
                "external_id": auth.currentUser.uid
            },
            "metadata": {
                "sucursal": branch,
                "order_id": orderId,
                "user_id": auth.currentUser.uid,
                "productos": JSON.stringify(cart.map(item => ({
                    nombre: item.nombre,
                    cantidad: item.cantidad,
                    precio: item.precio
                })))
            }
        };
        
        OpenPay.checkout.create(paymentData, successCallback, errorCallback);
        
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error en el pago',
            text: error.message
        });
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-lock"></i> Proceder al pago seguro';
    }
}

// Callbacks de OpenPay
async function successCallback(response) {
    console.log('Respuesta OpenPay:', response);
    
    if (response?.data?.checkout_link) {
        const orderId = response.data.order_id;
        
        try {
            // Actualizar la orden en Firestore
            await db.collection('orders').doc(orderId).update({
                payment_status: 'processing',
                checkout_link: response.data.checkout_link,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Actualizar el estado en localStorage
            const currentOrder = JSON.parse(localStorage.getItem('currentOrder'));
            if (currentOrder) {
                currentOrder.status = 'processing';
                currentOrder.checkout_link = response.data.checkout_link;
                localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
            }
            
            // Redirigir al checkout de OpenPay
            window.location.href = response.data.checkout_link;
            
        } catch (error) {
            console.error('Error al actualizar orden:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error al procesar',
                text: 'Hubo un problema al registrar tu pedido. Por favor contacta a soporte.'
            });
        }
    } else {
        throw new Error('No se recibió enlace de pago');
    }
}

async function errorCallback(response) {
    console.error('Error OpenPay:', response);
    
    // Actualizar estado en localStorage si hay un order_id
    if (response.data?.order_id) {
        try {
            await db.collection('orders').doc(response.data.order_id).update({
                status: 'failed',
                payment_status: 'failed',
                error_message: response.data?.description || response.message || 'Error desconocido',
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Actualizar estado en localStorage
            const currentOrder = JSON.parse(localStorage.getItem('currentOrder'));
            if (currentOrder) {
                currentOrder.status = 'failed';
                currentOrder.error = response.data?.description || response.message || 'Error desconocido';
                localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
            }
        } catch (error) {
            console.error('Error al actualizar orden fallida:', error);
        }
    }
    
    Swal.fire({
        icon: 'error',
        title: 'Error en el pago',
        text: response.data?.description || response.message || 'Error desconocido al procesar el pago'
    });
    
    const button = document.getElementById('btn-proceed-payment');
    if (button) {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-lock"></i> Proceder al pago seguro';
    }
}

// Funciones globales
window.updateQuantity = updateQuantity;
window.updateQuantityInput = updateQuantityInput;
window.removeItem = removeItem;
window.getCurrentOrderId = getCurrentOrderId;
</script>
    <script src="../../javascripts/navScript.js"></script>
</body>
</html>