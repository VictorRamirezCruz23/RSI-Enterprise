<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Compras | RSI Enterprise</title>
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/styles.css">
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/estilos-nav.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .main-content {
            margin-top: 85px;
            padding: 20px;
        }
        .history-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #1c1948;
            margin-bottom: 30px;
        }
        h2 {
            margin-top: 40px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .order-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .order-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .order-id {
            font-weight: bold;
            color: #1c1948;
        }
        .order-date {
            color: #666;
            font-size: 14px;
        }
        .order-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-completed {
            background-color: #e6f7ee;
            color: #4CAF50;
        }
        .status-delivered {
            background-color: #e6f7ee;
            color: #2E7D32;
        }
        .status-pending {
            background-color: #fff8e6;
            color: #FF9800;
        }
        .status-failed {
            background-color: #ffebee;
            color: #F44336;
        }
        .order-details {
            padding: 20px;
        }
        .order-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .order-summary > div {
            flex: 1;
            min-width: 200px;
        }
        .order-branch, .order-total, .order-method {
            margin: 5px 0;
        }
        .order-items {
            margin-top: 15px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .item-name {
            flex-grow: 1;
        }
        .item-price {
            min-width: 100px;
            text-align: right;
        }
        .item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-right: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .item-info {
            display: flex;
            align-items: center;
        }
        .no-orders {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
            display: none; /* Oculto por defecto */
        }
        .openpay-details, .delivery-details {
            margin-top: 15px;
            padding: 10px;
            background: #f5f5ff;
            border-radius: 5px;
            font-size: 14px;
        }
        .transaction-id {
            font-family: monospace;
            color: #1c1948;
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @media (max-width: 768px) {
            .main-content {
                margin-top: 28px;
            }
            .order-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .order-status {
                margin-top: 10px;
            }
            .order-summary {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body class="nan_reset">
<header class="nan_header">
    <nav class="nan_navbar">
        <div class="nan_logo">
            <a href="dashUser.html"><img src="../../../vista/css/img/Logo-RSI-OFICIAL.png" alt="Logo"></a>
        </div>
        <button class="nan_hamburger" aria-label="Abrir menú" aria-expanded="false">&#9776;</button>
        <button class="nan_close" aria-label="Cerrar menú" style="display: none;">&times;</button>
        <ul class="nan_menu">
            <li><a href="productos-usuario.html"><i class="fas fa-box"></i> Productos</a></li>&emsp; &emsp;
            <li><a href="historial-de-compras.html"><i class="fas fa-history"></i> Historial de compras</a></li>&emsp;&emsp;
            <li><a href="lista-de-deseos.html"><i class="fas fa-heart"></i> Lista de deseos</a></li>&emsp; &emsp;
            <li><a href="soporte.html"><i class="fas fa-headset"></i> Soporte</a></li>&emsp; &emsp;
            <li><a href="perfil.html"><i class="fas fa-user"></i> Mi perfil</a></li>&emsp; &emsp;
            <li><a href="#" id="cerrarSesion"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a></li>&emsp; &emsp;
            <li class="nan_language">
                <select id="languageSelect" class="language-select">
                    <option value="es" data-flag="../css/img/flag-mexico.png">🇲🇽</option>
                    <option value="en" data-flag="../css/img/flag-usa.png">🇺🇸</option>
                </select>
            </li>
        </ul>
    </nav>
</header>

<div class="main-content">
    <div class="history-container">
        <h1><i class="fas fa-history"></i> Historial de Compras</h1>
        
        <div id="loading-spinner" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Cargando historial de compras...
        </div>
        
        <div id="orders-list-container"></div>
        <div id="deliveries-list-container"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
// Configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
    authDomain: "rsienterprise.firebaseapp.com",
    projectId: "rsienterprise",
    storageBucket: "rsienterprise.appspot.com",
    messagingSenderId: "1063117165770",
    appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
};

// Inicializar Firebase
let firebaseApp, auth, db;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    console.log("Firebase inicializado correctamente");
} catch (error) {
    console.error("Error inicializando Firebase:", error);
    showFatalError("Error crítico: No se pudo inicializar la aplicación. Por favor recarga la página.");
}

// Mostrar spinner de carga
function showLoading(show) {
    document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
}

// Función principal para cargar el historial
async function loadPurchaseHistory() {
    showLoading(true);
    
    try {
        // Verificar autenticación
        const user = auth.currentUser;
        if (!user) {
            window.location.href = '/login';
            return;
        }

        // Consultar ambas colecciones en paralelo
        const [ordersSnapshot, deliveriesSnapshot] = await Promise.all([
            db.collection('orders').where('user_id', '==', user.uid).get(),
            db.collection('entregas').where('user_id', '==', user.uid).get()
        ]);

        // Procesar y mostrar órdenes
        const ordersListContainer = document.getElementById('orders-list-container');
        if (!ordersSnapshot.empty) {
            const orders = ordersSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                fecha: doc.data().created_at?.toDate() || null
            })).sort((a, b) => (b.fecha?.getTime() || 0) - (a.fecha?.getTime() || 0));
            
            ordersListContainer.innerHTML = `
                <h2 class="section-title"><i class="fas fa-shopping-bag"></i> Tus Órdenes</h2>
                ${orders.map(order => createOrderCard(order)).join('')}
            `;
        } else {
            ordersListContainer.innerHTML = `
                <div class="no-orders">
                    <i class="fas fa-shopping-bag" style="font-size: 50px; color: #ccc;"></i>
                    <h3>No hay órdenes registradas</h3>
                    <p>Aún no has realizado ninguna compra.</p>
                    <a href="productos-usuario.html" class="btn-continue">Ir a productos</a>
                </div>
            `;
        }

        // Procesar y mostrar entregas
        const deliveriesListContainer = document.getElementById('deliveries-list-container');
        if (!deliveriesSnapshot.empty) {
            const deliveries = deliveriesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                fecha: doc.data().fecha_entrega?.toDate() || null
            })).sort((a, b) => (b.fecha?.getTime() || 0) - (a.fecha?.getTime() || 0));
            
            deliveriesListContainer.innerHTML = `
                <h2 class="section-title"><i class="fas fa-truck"></i> Tus Entregas</h2>
                ${deliveries.map(delivery => createDeliveryCard(delivery)).join('')}
            `;
        } else {
            deliveriesListContainer.innerHTML = `
                <div class="no-orders">
                    <i class="fas fa-truck" style="font-size: 50px; color: #ccc;"></i>
                    <h3>No hay entregas registradas</h3>
                    <p>No se encontraron entregas para tus órdenes.</p>
                </div>
            `;
        }

    } catch (error) {
        console.error("Error al cargar historial:", error);
        document.getElementById('orders-list-container').innerHTML = `
            <div class="no-orders">
                <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: #f44336;"></i>
                <h3>Error al cargar el historial</h3>
                <p>${error.message || 'Ocurrió un problema al cargar tus compras'}</p>
                <button onclick="loadPurchaseHistory()" class="btn-continue">Reintentar</button>
            </div>
        `;
    } finally {
        showLoading(false);
    }
}

// Crear tarjeta de orden
function createOrderCard(order) {
    const total = order.amount || (order.items?.reduce((sum, item) => sum + (parseFloat(item.price) * (item.quantity || 1)), 0) || 0);
    
    return `
        <div class="order-card">
            <div class="order-header">
                <div>
                    <span class="order-id">Orden: ${order.id}</span>
                    ${order.fecha ? `
                    <span class="order-date">
                        ${order.fecha.toLocaleDateString('es-MX', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </span>
                    ` : ''}
                </div>
                ${order.payment_status ? `
                <span class="order-status ${getStatusClass(order.payment_status)}">
                    ${order.payment_status.toUpperCase()}
                </span>
                ` : ''}
            </div>
            <div class="order-details">
                <div class="order-summary">
                    ${order.branch ? `<div><strong>Sucursal:</strong> ${order.branch}</div>` : ''}
                    ${order.payment_method ? `<div><strong>Método de pago:</strong> ${order.payment_method}</div>` : ''}
                    <div><strong>Total:</strong> $${total.toFixed(2)} MXN</div>
                </div>
                
                ${order.openpay_id ? `
                <div class="openpay-details">
                    <div><strong>ID de transacción:</strong> <span class="transaction-id">${order.openpay_id}</span></div>
                </div>
                ` : ''}
                
                ${order.items?.length > 0 ? `
                <div class="order-items">
                    <h4>Productos:</h4>
                    ${order.items.map(item => `
                        <div class="order-item">
                            <div class="item-info">
                                ${item.image ? `<img src="${item.image}" alt="${item.name}" class="item-image">` : ''}
                                <span class="item-name">${item.quantity || 1} × ${item.name || 'Producto'}</span>
                            </div>
                            <span class="item-price">$${(parseFloat(item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Crear tarjeta de entrega
function createDeliveryCard(delivery) {
    const total = delivery.items?.reduce(
  (sum, item) => sum + (parseFloat(item.price || 0) * (item.quantity || 1)),
  0
) || 0;

    return `
        <div class="order-card">
            <div class="order-header">
                <div>
                    <span class="order-id">Entrega: ${delivery.id}</span>
                    ${delivery.fecha ? `
                    <span class="order-date">
                        ${delivery.fecha.toLocaleDateString('es-MX', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </span>
                    ` : ''}
                </div>
                ${delivery.estado ? `
                <span class="order-status ${getStatusClass(delivery.estado)}">
                    ${delivery.estado.toUpperCase()}
                </span>
                ` : ''}
            </div>
            <div class="order-details">
                <div class="order-summary">
                    ${delivery.order_id ? `<div><strong>Orden asociada:</strong> ${delivery.order_id}</div>` : ''}
                    ${delivery.metodo_entrega ? `<div><strong>Método de entrega:</strong> ${delivery.metodo_entrega}</div>` : ''}
                    ${delivery.direccion ? `<div><strong>Dirección:</strong> ${delivery.direccion}</div>` : ''}
                    <div><strong>Total:</strong> $${total.toFixed(2)} MXN</div>
                </div>
                
                ${delivery.items?.length > 0 ? `
                <div class="order-items">
                    <h4>Productos entregados:</h4>
                    ${delivery.items.map(item => `
                        <div class="order-item">
                            <div class="item-info">
                                ${item.image ? `<img src="${item.image}" alt="${item.name}" class="item-image">` : ''}
                                <span class="item-name">${item.quantity || 1} × ${item.name || 'Producto'}</span>
                            </div>
                            <span class="item-price">$${(parseFloat(item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${delivery.comentarios ? `
                <div class="delivery-details">
                    <strong>Comentarios:</strong> ${delivery.comentarios}
                </div>
                ` : ''}
                
                ${delivery.ubicacion_entrega ? `
                <div class="delivery-details">
                    <strong>Ubicación de entrega:</strong> ${delivery.ubicacion_entrega}
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Clases CSS para estados
function getStatusClass(status) {
    if (!status) return '';
    const statusLower = status.toLowerCase();
    if (statusLower.includes('complet') || statusLower.includes('entreg')) return 'status-completed';
    if (statusLower.includes('pendiente') || statusLower.includes('proceso')) return 'status-pending';
    if (statusLower.includes('cancel') || statusLower.includes('fall')) return 'status-failed';
    return '';
}

// Mostrar error crítico
function showFatalError(message) {
    document.getElementById('orders-container').innerHTML = `
        <div class="no-orders">
            <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: #f44336;"></i>
            <h3>Error crítico</h3>
            <p>${message}</p>
            <button onclick="window.location.reload()" class="btn-continue">Recargar página</button>
        </div>
    `;
}

// Inicialización cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
    // Verificar autenticación
    auth.onAuthStateChanged(user => {
        if (user) {
            loadPurchaseHistory();
        } else {
            window.location.href = '/login';
        }
    });
    
    // Manejar cierre de sesión
    document.getElementById('cerrarSesion')?.addEventListener('click', (e) => {
        e.preventDefault();
        auth.signOut()
            .then(() => window.location.href = '/login')
            .catch(error => {
                console.error("Error al cerrar sesión:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al cerrar sesión',
                    text: 'No se pudo cerrar la sesión. Por favor intenta nuevamente.'
                });
            });
    });
});

// Hacer función accesible globalmente
window.loadPurchaseHistory = loadPurchaseHistory;
</script>
<script src="../../javascripts/navScript.js"></script>
</body>
</html>