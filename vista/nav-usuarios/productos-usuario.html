<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://rsienterprise.com/vista/css/img/LOGO BLANCO.png">
    <title>RSI Enterprise - Productos</title>
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/styles.css">
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/index.css">
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/estilos-nav.css">
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/estilosTarjetas.css">
    <link rel="stylesheet" href="https://rsienterprise.com/vista/css/carrito.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <style>
    /* Estilos para las nuevas categorías */
    .categories-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 30px;
        padding: 20px 0;
        width: 100%;
    }

    .category-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 160px;
        text-decoration: none;
    }

    .category-card:hover {
        transform: translateY(-5px);
    }

    .category-image-container {
        position: relative;
        width: 140px;
        height: 140px;
        margin-bottom: 15px;
    }

    .category-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .category-card:hover .category-image {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        border-color: #4285F4;
    }

    .category-name {
        text-align: center;
        font-weight: 500;
        color: #333;
        max-width: 140px;
        word-wrap: break-word;
        font-size: 1.1rem;
    }

    /* Buscador - Estilos actualizados */
    .search-container {
        max-width: 800px;
        margin: 0 auto 30px;
        padding: 0 20px;
        position: relative;
    }

    .search-box {
        display: flex;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 30px;
        overflow: hidden;
        border: 2px solid #1a365d;
    }

    .search-input {
        flex: 1;
        padding: 12px 20px;
        border: none;
        font-size: 16px;
        outline: none;
    }

    .search-button {
        background-color: #1a365d;
        color: white;
        border: none;
        padding: 0 20px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .search-button:hover {
        background-color: #15325a;
    }

    /* Autocompletado */
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
    }

    .autocomplete-item:hover {
        background-color: #f5f5f5;
    }

    .autocomplete-item img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        margin-right: 10px;
    }

    .autocomplete-item .product-info {
        flex: 1;
    }

    .autocomplete-item .product-name {
        font-weight: 500;
        margin-bottom: 3px;
    }

    .autocomplete-item .product-sku {
        font-size: 12px;
        color: #666;
    }

    .highlight {
        background-color: #ffeb3b;
        padding: 0 2px;
    }

    /* Estilos mejorados para las tarjetas de productos */
    .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
        border: 1px solid #eaeaea;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
        border-color: #d1d5db;
    }

    .product-card > div {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .product-card .relative.aspect-square {
        background: #f9fafb;
        position: relative;
    }

    .product-card img {
        transition: transform 0.4s ease;
        mix-blend-mode: multiply;
    }

    .product-card:hover img {
        transform: scale(1.05);
    }

    .quick-view-btn {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        opacity: 0;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .product-card:hover .quick-view-btn {
        opacity: 1;
    }

    .quick-view-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    .product-card h3 {
        font-size: 15px;
        font-weight: 500;
        color: #374151;
        margin: 12px 12px 0;
        line-height: 1.4;
    }

    .product-card .mt-1 {
        padding: 0 12px 12px;
    }

    .product-card .text-custom-green {
        color: #1e40af;
        font-weight: 600;
    }

    .product-card .line-through {
        color: #9ca3af;
    }

    .product-card .action-buttons {
        padding: 0 12px 12px;
        margin-top: auto;
        display: flex;
        justify-content: flex-end;
        width: 100%;
    }

    .add-to-cart-btn {
        width: 42px;
        height: 42px;
        background-color: #1e40af !important;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .add-to-cart-btn:hover {
        transform: translateY(-3px) scale(1.05);
        background-color: #15325a !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .add-to-cart-btn i {
        font-size: 16px;
    }

    /* Estilos mejorados para el modal de vista rápida */
    #quick-view-modal {
        z-index: 1000;
    }

    #quick-view-modal .bg-white {
        max-width: 420px;
        width: 90%;
        border-radius: 16px;
        overflow: hidden;
        border: none;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    #quick-view-modal .p-4 {
        padding: 24px;
    }

    #quick-view-modal .border-b {
        border-bottom: 1px solid #f3f4f6;
        padding: 16px 24px;
        background: #f9fafb;
    }

    #quick-view-modal h2 {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    #quick-view-modal .close-modal {
        font-size: 20px;
        transition: all 0.2s ease;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
    }

    #quick-view-modal .close-modal:hover {
        transform: rotate(90deg);
        color: #111827;
    }

    #quick-view-image {
        height: 220px;
        width: 100%;
        object-fit: contain;
        margin-bottom: 16px;
        border-radius: 8px;
        background: #f9fafb;
        padding: 20px;
    }

    #quick-view-name {
        font-size: 17px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    #quick-view-price {
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
    }

    /* Estilos mejorados para el modal de detalle */
    #detail-view {
        z-index: 1001;
    }

    #detail-view .container {
        max-width: 1200px;
        width: 95%;
        padding: 40px;
        border-radius: 16px;
        margin: 40px auto;
        position: relative;
        animation: modalSlideIn 0.4s ease-out;
    }

    @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(50px); }
        to { opacity: 1; transform: translateY(0); }
    }

    #close-detail {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        transition: all 0.2s ease;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1002;
    }

    #close-detail:hover {
        background: #e5e7eb;
        transform: rotate(90deg);
    }

    #detail-image {
        max-height: 500px;
        width: 100%;
        object-fit: contain;
        background: #f9fafb;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }

    .image-nav-button {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: #111827;
        transition: all 0.2s ease;
        border: none;
        position: absolute;
        cursor: pointer;
    }

    .image-nav-button:hover {
        background: white;
        transform: scale(1.1);
    }

    #thumbnails {
        display: flex;
        gap: 12px;
        padding: 8px 0;
        margin-bottom: 20px;
    }

    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        background: #f9fafb;
    }

    .thumbnail:hover {
        border-color: #d1d5db;
    }

    .thumbnail.active {
        border-color: #1e40af;
        transform: scale(1.05);
    }

    #detail-name {
        font-size: 28px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 16px;
        line-height: 1.3;
    }

    #detail-price {
        font-size: 32px;
        margin-bottom: 24px;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    #product-details {
        margin-top: 24px;
        padding: 20px;
        background: #f9fafb;
        border-radius: 12px;
    }

    #product-details p {
        margin-bottom: 12px;
        font-size: 15px;
        color: #4b5563;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    #product-details p:last-child {
        border-bottom: none;
    }

    #product-details strong {
        color: #111827;
        font-weight: 500;
        min-width: 140px;
        display: inline-block;
    }

    .button-container {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
    }

    .button-container button {
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .button-container button:first-child {
        background: #1e40af;
        color: white;
    }

    .button-container button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
        #detail-view .container {
            flex-direction: column;
        }
        
        #detail-view .md\:w-1\/2 {
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        #detail-view .container {
            padding: 24px;
        }
        
        #detail-name {
            font-size: 24px;
        }
        
        #detail-price {
            font-size: 26px;
        }
        
        .button-container {
            flex-direction: column;
            gap: 12px;
        }
        
        .button-container button {
            width: 100%;
        }

        .product-card .action-buttons {
            padding: 0 8px 8px;
            margin-top: 8px;
        }
        
        .add-to-cart-btn {
            width: 38px;
            height: 38px;
        }
        
        .add-to-cart-btn i {
            font-size: 14px;
        }
    }

    @media (max-width: 480px) {
        #detail-view .container {
            padding: 16px;
            margin: 20px auto;
        }
        
        #detail-name {
            font-size: 20px;
        }
        
        .thumbnail {
            width: 60px;
            height: 60px;
        }
        
        #quick-view-modal .bg-white {
            width: 95%;
        }

        .categories-container {
            gap: 15px;
        }
        
        .category-image-container {
            width: 80px;
            height: 80px;
        }
        
        .category-card {
            width: 90px;
        }
        
        .category-name {
            font-size: 0.9rem;
        }

        .search-box {
            flex-direction: column;
            border-radius: 8px;
        }

        .search-input {
            border-radius: 8px 8px 0 0;
        }

        .search-button {
            padding: 10px;
            border-radius: 0 0 8px 8px;
        }

        .product-card .action-buttons {
            padding: 0 6px 6px;
        }
        
        .add-to-cart-btn {
            width: 36px;
            height: 36px;
        }
    }
    /* Animación del spinner */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    /* Transición suave para el overlay */
    .transition-opacity {
        transition-property: opacity;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .duration-300 {
        transition-duration: 300ms;
    }
    /* Estilo para el loader */
#loading-overlay {
    backdrop-filter: blur(5px);
    background-color: rgba(255, 255, 255, 0.9);
}

.loader {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid #1a365d;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}
</style>
</head>
<body class="nan_reset">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-38F2DBG9HE"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-38F2DBG9HE');
    </script>
    <header class="nan_header">
    <nav class="nan_navbar">
        <div class="nan_logo">
            <a href="dashUser.html"><img src="https://rsienterprise.com/vista/css/img/Logo-RSI-OFICIAL.png" alt="Logo"></a>
        </div>
        <!-- Botón de hamburguesa para móviles -->
        <button class="nan_hamburger" aria-label="Abrir menú" aria-expanded="false">&#9776;</button>
        <!-- Botón de cierre (X) -->
        <button class="nan_close" aria-label="Cerrar menú" style="display: none;">&times;</button>
         <ul class="nan_menu">
            <li><a href="productos-usuario.html"><i class="fas fa-box"></i> Productos</a></li>&emsp; &emsp;
            <li><a href="historial-de-compras.html"><i class="fas fa-history"></i> Historial de compras</a></li>&emsp;&emsp;
            <li><a href="lista-de-deseos.html"><i class="fas fa-heart"></i> Lista de deseos</a></li>&emsp; &emsp;
            <li><a href="soporte.html"><i class="fas fa-headset"></i> Soporte</a></li>&emsp; &emsp;
            <li><a href="perfil.html"><i class="fas fa-user"></i> Mi perfil</a></li>&emsp; &emsp;
            <li><a href="#" id="cerrarSesion"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a></li>&emsp; &emsp;
            <li class="nan_language">
                <select id="languageSelect" class="language-select">
                    <option value="es" data-flag="../css/img/flag-mexico.png">🇲🇽</option>
                    <option value="en" data-flag="../css/img/flag-usa.png">🇺🇸</option>
                </select>
            </li>
        </ul>
    </nav>
</header>
    <script src="https://rsienterprise.com/javascripts/nav.js"></script>
    <a href="https://wa.me/5551391533" class="whatsapp-float" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/124/124034.png" alt="WhatsApp">
    </a>

    <!-- Contenedor del carrito -->
    <div id="cart-sidebar" class="cart-sidebar">
        <h2>Carrito de Compras <button id="close-cart">&times;</button></h2>
        <div id="cart-items"></div>
        <button id="checkout" class="openpay-button">Finalizar Compra</button>
    </div>

    <!-- Botón flotante del carrito -->
    <div id="floating-cart-btn" class="floating-cart-btn">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count">0</span>
    </div>

    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <main class="container mx-auto px-4">
        <!-- Buscador de productos mejorado -->
         <br>
        <section class="my-8">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-input" class="search-input" placeholder="Buscar productos por nombre, marca, modelo o SKU..." autocomplete="off">
                    <button id="search-button" class="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="autocomplete-results" class="autocomplete-results"></div>
            </div>
        </section>

        <!-- Sección de categorías -->
        <section class="my-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Explora nuestras categorías</h2>
            <div id="categoriesContainer" class="categories-container"></div>
        </section>

        <!-- Sección de productos -->
        <div id="productsContainer" class="hidden">
            <h2 id="categoryTitle" class="text-2xl font-bold mb-6 text-gray-800"></h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="productsGrid"></div>
            <div id="paginationControls" class="mt-6 flex justify-center items-center gap-4">
                <button id="prevPage" class="bg-gray-800 text-white px-4 py-2 rounded-lg disabled:opacity-50" disabled>Anterior</button>
                <span id="currentPage" class="text-gray-600">Página 1</span>
                <button id="nextPage" class="bg-gray-800 text-white px-4 py-2 rounded-lg disabled:opacity-50" disabled>Siguiente</button>
            </div>
        </div>

        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center transition-opacity duration-300 hidden">
        <div class="loader animate-spin rounded-full border-4 border-t-4 border-gray-200 border-t-blue-600 h-12 w-12 mb-4"></div>
        <p class="text-gray-600 text-lg font-medium">Cargando productos...</p>
    </div>
    </main>

    <!-- Modales -->
    <div id="quick-view-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-900">Vista Rápida</h2>
                <button class="close-modal text-gray-400 hover:text-gray-500">
                    ✕
                </button>
            </div>
            <div class="p-4">
                <img id="quick-view-image" class="w-full h-48 object-contain rounded-md" src="" alt="">
                <h3 id="quick-view-name" class="text-xl font-semibold text-gray-900 my-2"></h3>
                <p id="quick-view-price" class="text-2xl font-bold mb-4 text-custom-green"></p>
                <div class="flex justify-between">
                    <button id="quick-view-wishlist" class="bg-blue-900 text-white px-4 py-2 rounded-md hover:bg-blue-800">
                        <i class="fas fa-heart mr-2"></i>Lista de deseos
                    </button>
                    <button id="quick-view-cart" class="bg-blue-900 text-white px-4 py-2 rounded-md hover:bg-blue-800">
                        <i class="fas fa-shopping-cart mr-2"></i>Añadir al carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-view" class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto hidden">
        <div class="container mx-auto px-4 py-8 bg-white min-h-screen">
            <button id="close-detail" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full hover:bg-gray-200">
                ✕
            </button>
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/2">
                    <div class="relative">
                        <img id="detail-image" class="w-full h-auto rounded-lg" src="" alt="">
                        <button id="prev-image" class="image-nav-button absolute left-2 top-1/2 transform -translate-y-1/2 p-2 rounded-full shadow-md">←</button>
                        <button id="next-image" class="image-nav-button absolute right-2 top-1/2 transform -translate-y-1/2 p-2 rounded-full shadow-md">→</button>
                    </div>
                    <div id="thumbnails" class="flex gap-2 mt-4 overflow-x-auto pb-2"></div>
                </div>
                <div class="md:w-1/2">
                    <h1 id="detail-name" class="text-3xl font-bold mb-4"></h1>
                    <p id="detail-price" class="text-3xl font-bold text-custom-green mb-6"></p>
                    <div class="flex gap-4 mb-6">
                        <button id="detail-wishlist-btn" class="bg-blue-900 text-white px-6 py-3 rounded-md font-medium hover:bg-blue-800 transition-colors flex items-center gap-2">
                            <i class="fas fa-heart"></i>
                            Agregar a deseos
                        </button>
                        <button id="detail-cart-btn" class="bg-blue-900 text-white px-6 py-3 rounded-md font-medium hover:bg-blue-800 transition-colors flex items-center gap-2">
                            <i class="fas fa-shopping-cart"></i>
                            Añadir al carrito
                        </button>
                    </div>
                    <div id="product-details" class="space-y-4">
                        <p><strong>Marca:</strong> <span id="detail-brand">N/A</span></p>
                        <p><strong>Modelo:</strong> <span id="detail-model">N/A</span></p>
                        <p><strong>Categoría:</strong> <span id="detail-category">N/A</span></p>
                        <p><strong>Tipo:</strong> <span id="detail-type">N/A</span></p>
                        <p class="pr-4"><strong>Especificaciones:</strong> <span id="detail-specs">No hay especificaciones disponibles</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>  
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs, doc, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
        authDomain: "rsienterprise.firebaseapp.com",
        projectId: "rsienterprise",
        storageBucket: "rsienterprise.appspot.com",
        messagingSenderId: "1063117165770",
        appId: "1:1063117165770:web:8555f26b25ae80bc42d033"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Variables globales
    const loadingOverlay = document.getElementById('loading-overlay');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const productsContainer = document.getElementById('productsContainer');
    const productsGrid = document.getElementById('productsGrid');
    const categoryTitle = document.getElementById('categoryTitle');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const autocompleteResults = document.getElementById('autocomplete-results');
    const defaultImage = 'https://rsienterprise.com/vista/css/img/Logo-RSI-OFICIAL.png';
    const wishlistCount = document.getElementById('wishlist-count');

    let currentProducts = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentCategory = '';
    let currentUser = null;
    let currentDetailProduct = null;
    let allProducts = [];
    let searchTimeout = null;

    // Funciones para manejar el loader
    function showLoader() {
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.style.opacity = '1';
    }

    function hideLoader() {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.classList.add('hidden');
        }, 300);
    }

    // Verificar estado de autenticación
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            updateWishlistCount();
            loadAllProducts(); // Cargar todos los productos para búsqueda
            loadCategories(); // Cargar categorías después de autenticación
        } else {
            window.location.href = 'login.html';
        }
    });

    // Cargar todos los productos para búsqueda
    async function loadAllProducts() {
        try {
            showLoader();
            const querySnapshot = await getDocs(collection(db, "Productos"));
            allProducts = querySnapshot.docs.map(doc => {
                const data = doc.data();
                data.id = doc.id;
                data.sku = data.SKU || doc.id;
                return data;
            });
        } catch (error) {
            console.error("Error cargando productos para búsqueda:", error);
        } finally {
            hideLoader();
        }
    }

    // Función para resaltar texto en los resultados
    function highlightText(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // Mostrar sugerencias de autocompletado
    function showAutocompleteResults(term) {
        if (!term.trim() || !allProducts.length) {
            autocompleteResults.style.display = 'none';
            return;
        }

        const termLower = term.toLowerCase();
        const results = allProducts.filter(product => {
            return (
                (product['Nombre Producto']?.toLowerCase().includes(termLower)) ||
                (product.Marca?.toLowerCase().includes(termLower)) ||
                (product.Modelo?.toLowerCase().includes(termLower)) ||
                (product.Categoria?.toLowerCase().includes(termLower)) ||
                (product.Tipo?.toLowerCase().includes(termLower)) ||
                (product.Especificaciones?.toLowerCase().includes(termLower)) ||
                (product.sku?.toLowerCase().includes(termLower))
            );
        }).slice(0, 5);

        if (results.length === 0) {
            autocompleteResults.style.display = 'none';
            return;
        }

        autocompleteResults.innerHTML = '';
        results.forEach(product => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = `
                <img src="${product.Imagenes?.[0] || defaultImage}" onerror="this.src='${defaultImage}'">
                <div class="product-info">
                    <div class="product-name">${highlightText(product['Nombre Producto'] || 'Sin nombre', term)}</div>
                    <div class="product-sku">SKU: ${highlightText(product.sku, term)}</div>
                </div>
            `;
            item.addEventListener('click', () => {
                searchInput.value = product['Nombre Producto'];
                searchProducts(product['Nombre Producto']);
                autocompleteResults.style.display = 'none';
            });
            autocompleteResults.appendChild(item);
        });

        autocompleteResults.style.display = 'block';
    }

    // Buscar productos
    function searchProducts(searchTerm) {
        if (!searchTerm.trim()) {
            if (currentCategory) {
                categoryTitle.textContent = currentCategory;
                renderProducts();
            } else {
                productsContainer.classList.add('hidden');
            }
            return;
        }

        showLoader();
        
        const term = searchTerm.toLowerCase();
        const results = allProducts.filter(product => {
            return (
                (product['Nombre Producto']?.toLowerCase().includes(term)) ||
                (product.Marca?.toLowerCase().includes(term)) ||
                (product.Modelo?.toLowerCase().includes(term)) ||
                (product.Categoria?.toLowerCase().includes(term)) ||
                (product.Tipo?.toLowerCase().includes(term)) ||
                (product.Especificaciones?.toLowerCase().includes(term)) ||
                (product.sku?.toLowerCase().includes(term))
            );
        });

        currentProducts = results;
        currentPage = 1;
        totalPages = Math.ceil(currentProducts.length / 20);
        categoryTitle.textContent = `Resultados para: "${searchTerm}"`;
        renderProducts();
        updatePaginationControls();
        productsContainer.classList.remove('hidden');
        
        hideLoader();
        
        // Scroll a la sección de productos
        setTimeout(() => {
            document.getElementById('productsContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }, 100);
    }

    // Event listeners para búsqueda
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            showAutocompleteResults(searchInput.value);
        }, 300);
    });

    searchButton.addEventListener('click', () => {
        searchProducts(searchInput.value);
        autocompleteResults.style.display = 'none';
    });

    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchProducts(searchInput.value);
            autocompleteResults.style.display = 'none';
        }
    });

    // Cerrar autocompletado al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
            autocompleteResults.style.display = 'none';
        }
    });

    // Cerrar sesión
    document.getElementById('cerrarSesion').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await signOut(auth);
            window.location.href = 'login.html';
        } catch (error) {
            console.error("Error al cerrar sesión:", error);
            Swal.fire("Error", "No se pudo cerrar la sesión", "error");
        }
    });

    // Actualizar contador de wishlist
    async function updateWishlistCount() {
        if (!currentUser) return;
        
        try {
            const wishlistRef = doc(db, "wishlists", currentUser.uid);
            const docSnap = await getDoc(wishlistRef);
            
            if (docSnap.exists()) {
                const count = docSnap.data().products?.length || 0;
                wishlistCount.textContent = count;
                wishlistCount.style.display = count > 0 ? 'flex' : 'none';
            } else {
                wishlistCount.style.display = 'none';
            }
        } catch (error) {
            console.error("Error al actualizar contador de wishlist:", error);
        }
    }

    // Cargar categorías
    async function loadCategories() {
        try {
            showLoader();
            const querySnapshot = await getDocs(collection(db, "categorias"));
            categoriesContainer.innerHTML = '';
            
            if (querySnapshot.empty) {
                categoriesContainer.innerHTML = '<p class="text-center w-full">No se encontraron categorías</p>';
                return;
            }
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                createCategoryCard(data);
            });
        } catch (error) {
            console.error("Error cargando categorías:", error);
            categoriesContainer.innerHTML = '<p class="text-center w-full text-red-500">Error al cargar categorías</p>';
        } finally {
            hideLoader();
        }
    }

    // Crear tarjeta de categoría
    function createCategoryCard(category) {
        const card = document.createElement('div');
        card.className = 'category-card';
        
        const imageContainer = document.createElement('div');
        imageContainer.className = 'category-image-container';
        
        const image = document.createElement('img');
        image.className = 'category-image';
        image.src = category.imagen || defaultImage;
        image.alt = category.nombre || 'Categoría';
        image.onerror = () => { image.src = defaultImage; };
        
        const name = document.createElement('div');
        name.className = 'category-name';
        name.textContent = category.nombre || 'Categoría';
        
        imageContainer.appendChild(image);
        card.appendChild(imageContainer);
        card.appendChild(name);
        
        card.addEventListener('click', () => {
            currentCategory = category.nombre;
            categoryTitle.textContent = category.nombre;
            loadCategoryProducts(category.nombre);
        });
        
        categoriesContainer.appendChild(card);
    }

    // Cargar productos por categoría
    async function loadCategoryProducts(category) {
        try {
            showLoader();
            productsContainer.classList.add('hidden');
            
            const q = query(collection(db, "Productos"), where("Categoria", "==", category));
            const querySnapshot = await getDocs(q);
            
            currentProducts = [];
            querySnapshot.forEach((doc) => {
                const productData = doc.data();
                productData.id = doc.id;
                productData.sku = productData.SKU || doc.id;
                currentProducts.push(productData);
            });
            
            currentPage = 1;
            totalPages = Math.ceil(currentProducts.length / 20);
            renderProducts();
            updatePaginationControls();
            
            productsContainer.classList.remove('hidden');
            
            // Scroll suave a la sección de productos
            document.querySelector('#productsContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
        } catch (error) {
            console.error("Error cargando productos:", error);
            Swal.fire("Error", "No se pudieron cargar los productos", "error");
        } finally {
            hideLoader();
        }
    }

    // Renderizar productos
    function renderProducts() {
        const startIndex = (currentPage - 1) * 20;
        const endIndex = startIndex + 20;
        const productsToShow = currentProducts.slice(startIndex, endIndex);
        
        productsGrid.innerHTML = '';
        
        if (productsToShow.length === 0) {
            productsGrid.innerHTML = '<p class="col-span-full text-center py-8">No se encontraron productos</p>';
            return;
        }
        
        productsToShow.forEach(product => {
            const card = createProductCard(product);
            productsGrid.appendChild(card);
        });
    }

    // Crear tarjeta de producto
    function createProductCard(product) {
        const productImage = product.Imagenes?.[0] || defaultImage;
        const productId = product.id || product['Nombre Producto'].replace(/\s+/g, '-').toLowerCase();
        
        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.productId = productId;
        
        card.innerHTML = `
            <div class="cursor-pointer">
                <div class="relative aspect-square overflow-hidden">
                    <img src="${productImage}" 
                         alt="${product['Nombre Producto']}" 
                         class="w-full h-full object-contain"
                         onerror="this.src='${defaultImage}'">
                    <button class="quick-view-btn absolute top-2 right-2 bg-white p-1.5 rounded-full shadow-md">
                        👁️
                    </button>
                </div>
                <h3 class="text-sm font-medium text-gray-900 truncate">${product['Nombre Producto']}</h3>
                <div class="mt-1">
                    <span class="bg-red-500 text-white text-sm px-2 py-1 rounded-md">10% OFF</span>
                    <p class="text-2xl font-semibold text-custom-green">
                        <span class="line-through text-gray-400 text-xl mr-2">
                            $${(Number(product['Precio MXN']) || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}
                        </span>
                        $${(Number(product['Precio MXN'] * 0.90) || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}
                    </p>
                    <p class="text-sm text-gray-500">Pesos mexicanos</p>
                    <p class="text-xs text-gray-400 mt-1">SKU: ${product.sku || product.id}</p>
                </div>
                <br>
                <div class="flex justify-end mt-2 space-x-2">
                    <button class="wishlist-btn w-12 h-12 bg-blue-900 text-white rounded-full flex items-center justify-center hover:bg-blue-800">
                        <i class="fas fa-heart text-base"></i>
                    </button>
                    <button class="add-to-cart-btn w-12 h-12 bg-blue-900 text-white rounded-full flex items-center justify-center hover:bg-blue-800">
                        <i class="fas fa-shopping-cart text-base"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Eventos para la tarjeta
        const cartButton = card.querySelector('.add-to-cart-btn');
        const wishlistButton = card.querySelector('.wishlist-btn');
        const quickViewButton = card.querySelector('.quick-view-btn');
        
        cartButton.addEventListener('click', (e) => {
            e.stopPropagation();
            addToCart(product);
        });
        
        wishlistButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            await toggleWishlist(product, wishlistButton);
        });
        
        quickViewButton.addEventListener('click', (e) => {
            e.stopPropagation();
            showQuickView(product);
        });
        
        // Verificar si el producto está en la wishlist
        checkWishlistStatus(product, wishlistButton);
        
        card.addEventListener('click', (e) => {
            if (e.target.closest('.quick-view-btn') || 
                e.target.closest('.add-to-cart-btn') || 
                e.target.closest('.wishlist-btn')) {
                return;
            }
            showDetailView(product);
        });
        
        return card;
    }

    // Verificar estado del producto en la wishlist
    async function checkWishlistStatus(product, button) {
        if (!currentUser) return;
        
        try {
            const wishlistRef = doc(db, "wishlists", currentUser.uid);
            const docSnap = await getDoc(wishlistRef);
            
            if (docSnap.exists()) {
                const products = docSnap.data().products || [];
                const productId = product.id || product['Nombre Producto'];
                const isInWishlist = products.some(p => p.id === productId);
                
                if (isInWishlist) {
                    button.classList.add('active');
                    button.innerHTML = '<i class="fas fa-heart text-base text-red-500"></i>';
                }
            }
        } catch (error) {
            console.error("Error verificando wishlist:", error);
        }
    }

    // Alternar producto en wishlist
    async function toggleWishlist(product, button) {
        if (!currentUser) {
            Swal.fire("Error", "Debes iniciar sesión para usar la lista de deseos", "error");
            return;
        }
        
        try {
            const productId = product.id || product['Nombre Producto'];
            const wishlistRef = doc(db, "wishlists", currentUser.uid);
            const docSnap = await getDoc(wishlistRef);
            
            const productData = {
                id: productId,
                name: product['Nombre Producto'],
                price: product['Precio MXN'],
                image: product.Imagenes?.[0] || defaultImage,
                category: product.Categoria,
                sku: product.sku || product.id,
                addedAt: new Date().toISOString()
            };
            
            if (docSnap.exists()) {
                // Verificar si el producto ya está en la wishlist
                const wishlistData = docSnap.data();
                const products = wishlistData.products || [];
                const productIndex = products.findIndex(p => p.id === productId);
                
                if (productIndex !== -1) {
                    // Eliminar de la wishlist
                    await updateDoc(wishlistRef, {
                        products: arrayRemove(products[productIndex]),
                        updatedAt: new Date().toISOString()
                    });
                    
                    button.classList.remove('active');
                    button.innerHTML = '<i class="fas fa-heart text-base"></i>';
                    Swal.fire("Eliminado", "Producto removido de tu lista de deseos", "success");
                } else {
                    // Agregar a la wishlist
                    await updateDoc(wishlistRef, {
                        products: arrayUnion(productData),
                        updatedAt: new Date().toISOString()
                    });
                    
                    button.classList.add('active');
                    button.innerHTML = '<i class="fas fa-heart text-base text-red-500"></i>';
                    Swal.fire("¡Agregado!", "Producto añadido a tu lista de deseos", "success");
                }
            } else {
                // Crear nueva wishlist
                await setDoc(wishlistRef, {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    products: [productData],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                button.classList.add('active');
                button.innerHTML = '<i class="fas fa-heart text-base text-red-500"></i>';
                Swal.fire("¡Agregado!", "Producto añadido a tu lista de deseos", "success");
            }
            
            // Actualizar contador
            await updateWishlistCount();
        } catch (error) {
            console.error("Error al actualizar wishlist:", error);
            Swal.fire("Error", "No se pudo actualizar la lista de deseos", "error");
        }
    }

    // Actualizar controles de paginación
    function updatePaginationControls() {
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');
        const pageIndicator = document.getElementById('currentPage');
        
        pageIndicator.textContent = `Página ${currentPage} de ${totalPages || 1}`;
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Eventos de paginación
    document.getElementById('prevPage').addEventListener('click', () => {
        if(currentPage > 1) {
            currentPage--;
            renderProducts();
            updatePaginationControls();
            window.scrollTo({ top: productsContainer.offsetTop - 20, behavior: 'smooth' });
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        if(currentPage < totalPages) {
            currentPage++;
            renderProducts();
            updatePaginationControls();
            window.scrollTo({ top: productsContainer.offsetTop - 20, behavior: 'smooth' });
        }
    });

    // Mostrar vista rápida
    function showQuickView(product) {
        const modal = document.getElementById('quick-view-modal');
        const image = document.getElementById('quick-view-image');
        const name = document.getElementById('quick-view-name');
        const price = document.getElementById('quick-view-price');
        const wishlistBtn = document.getElementById('quick-view-wishlist');
        const cartBtn = document.getElementById('quick-view-cart');
        
        image.src = product.Imagenes?.[0] || defaultImage;
        name.textContent = product['Nombre Producto'] || 'Producto sin nombre';
        price.textContent = `$${(product['Precio MXN'] * 0.90 || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
        
        // Configurar botones
        wishlistBtn.onclick = async () => {
            await toggleWishlist(product);
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        cartBtn.onclick = () => {
            addToCart(product);
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        modal.classList.remove('hidden');
        modal.classList.add('active');
        
        modal.querySelector('.close-modal').addEventListener('click', () => {
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        });
    }

    // Mostrar vista detallada
    function showDetailView(product) {
        const modal = document.getElementById('detail-view');
        const images = product.Imagenes || [defaultImage];
        let currentImageIndex = 0;
        currentDetailProduct = product;

        // Actualizar información básica
        document.getElementById('detail-image').src = images[0];
        document.getElementById('detail-image').alt = product['Nombre Producto'] || 'Producto';
        document.getElementById('detail-name').textContent = product['Nombre Producto'] || 'Producto sin nombre';
        document.getElementById('detail-price').textContent = `$${(product['Precio MXN'] * 0.90 || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
        document.getElementById('detail-brand').textContent = product.Marca || 'N/A';
        document.getElementById('detail-model').textContent = product.Modelo || 'N/A';
        document.getElementById('detail-category').textContent = product.Categoria || 'N/A';
        document.getElementById('detail-type').textContent = product.Tipo || 'N/A';
        document.getElementById('detail-specs').textContent = product.Especificaciones || 'No hay especificaciones disponibles';

        // Configurar botones
        document.getElementById('detail-cart-btn').onclick = () => {
            addToCart(product);
        };

        document.getElementById('detail-wishlist-btn').onclick = async () => {
            await toggleWishlist(product);
            // Actualizar el estado del botón en el modal
            const isInWishlist = await checkProductInWishlist(product);
            const wishlistBtn = document.getElementById('detail-wishlist-btn');
            
            if (isInWishlist) {
                wishlistBtn.innerHTML = '<i class="fas fa-heart"></i> Eliminar de deseos';
                wishlistBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                wishlistBtn.classList.remove('bg-blue-900', 'hover:bg-blue-800');
            } else {
                wishlistBtn.innerHTML = '<i class="fas fa-heart"></i> Agregar a deseos';
                wishlistBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                wishlistBtn.classList.add('bg-blue-900', 'hover:bg-blue-800');
            }
        };

        // Verificar estado inicial del botón de wishlist
        checkProductInWishlist(product).then(isInWishlist => {
            const wishlistBtn = document.getElementById('detail-wishlist-btn');
            
            if (isInWishlist) {
                wishlistBtn.innerHTML = '<i class="fas fa-heart"></i> Eliminar de deseos';
                wishlistBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                wishlistBtn.classList.remove('bg-blue-900', 'hover:bg-blue-800');
            }
        });

        // Configurar galería de imágenes
        const thumbnailsContainer = document.getElementById('thumbnails');
        thumbnailsContainer.innerHTML = '';

        function updateMainImage() {
            document.getElementById('detail-image').src = images[currentImageIndex];
            document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentImageIndex);
            });
        }

        images.forEach((img, index) => {
            const thumbnail = document.createElement('img');
            thumbnail.className = `thumbnail w-20 h-20 object-cover rounded cursor-pointer border-2 ${index === 0 ? 'active border-custom-green' : 'border-transparent'}`;
            thumbnail.src = img;
            thumbnail.onerror = () => { thumbnail.src = defaultImage; };
            thumbnail.addEventListener('click', () => {
                currentImageIndex = index;
                updateMainImage();
            });
            thumbnailsContainer.appendChild(thumbnail);
        });

        // Event listeners para navegación
        document.getElementById('prev-image').addEventListener('click', () => {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateMainImage();
            }
        });

        document.getElementById('next-image').addEventListener('click', () => {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateMainImage();
            }
        });

        // Mostrar modal
        modal.classList.remove('hidden');
        modal.classList.add('active');
        
        document.getElementById('close-detail').addEventListener('click', () => {
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        });
    }

    // Verificar si un producto está en la wishlist
    async function checkProductInWishlist(product) {
        if (!currentUser) return false;
        
        try {
            const productId = product.id || product['Nombre Producto'];
            const wishlistRef = doc(db, "wishlists", currentUser.uid);
            const docSnap = await getDoc(wishlistRef);
            
            if (docSnap.exists()) {
                const products = docSnap.data().products || [];
                return products.some(p => p.id === productId);
            }
            return false;
        } catch (error) {
            console.error("Error verificando wishlist:", error);
            return false;
        }
    }

    // Función para añadir al carrito
    window.addToCart = function(product) {
        if (typeof product === "string") {
            product = JSON.parse(product.replace(/&quot;/g, '"'));
        }

        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const existingProductIndex = cart.findIndex(item => item.nombre === product["Nombre Producto"]);

        if (existingProductIndex !== -1) {
            cart[existingProductIndex].cantidad += 1;
        } else {
            cart.push({
                imagen: product.Imagenes && product.Imagenes.length > 0 ? product.Imagenes[0] : defaultImage,
                nombre: product["Nombre Producto"],
                precio: (product["Precio MXN"] * 0.90) || "No disponible",
                cantidad: 1,
                id: product.id || product["Nombre Producto"].replace(/\s+/g, '-').toLowerCase(),
                sku: product.sku || product.id
            });
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        renderCartItems();
        Swal.fire("¡Producto agregado!", `${product["Nombre Producto"]} se ha añadido al carrito.`, "success");
    };

    // Actualizar contador del carrito
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        document.getElementById("cart-count").textContent = cart.length;
    }

    // Renderizar items del carrito
    function renderCartItems() {
        const cartItemsContainer = document.getElementById("cart-items");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        let subtotal = 0;

        cartItemsContainer.innerHTML = "";

        cart.forEach((item, index) => {
            const precio = parseFloat(item.precio) || 0;
            const totalItem = precio * item.cantidad;
            subtotal += totalItem;

            const cartItem = document.createElement("div");
            cartItem.classList.add("cart-item");
            cartItem.innerHTML = `
                <img src="${item.imagen}" alt="${item.nombre}" style="width: 50px; height: 50px;">
                <span class="product-name">${item.nombre}</span>
                <div class="quantity-controls">
                    <button onclick="updateQuantity(${index}, ${item.cantidad - 1})">-</button>
                    <input type="number" value="${item.cantidad}" min="1" onchange="updateQuantity(${index}, this.value)">
                    <button onclick="updateQuantity(${index}, ${item.cantidad + 1})">+</button>
                </div>
                <button class="remove-btn" onclick="removeFromCart(${index})"><i class="fas fa-trash"></i></button>
            `;
            cartItemsContainer.appendChild(cartItem);
        });

        cartItemsContainer.innerHTML += `
            <div class="cart-subtotal">
                <span>Subtotal:</span>
                <span>$${subtotal.toFixed(2)}</span>
            </div>
        `;
    }

    // Funciones globales para el carrito
    window.updateQuantity = function(index, newQuantity) {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        if (newQuantity < 1) newQuantity = 1;
        cart[index].cantidad = parseInt(newQuantity, 10);
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        renderCartItems();
    };

    window.removeFromCart = function(index) {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        renderCartItems();
    };

    // Inicializar carrito
    document.addEventListener("DOMContentLoaded", function() {
        const floatingCartBtn = document.getElementById("floating-cart-btn");
        const cartSidebar = document.getElementById("cart-sidebar");
        const closeCart = document.getElementById("close-cart");
        const checkoutButton = document.getElementById("checkout");

        // Actualizar carrito al cargar la página
        updateCartCount();
        renderCartItems();

        // Event listeners para el carrito
        floatingCartBtn.addEventListener("click", function() {
            cartSidebar.classList.toggle("open");
        });

        closeCart.addEventListener("click", function() {
            cartSidebar.classList.remove("open");
        });

        checkoutButton.addEventListener("click", function() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (cart.length === 0) {
                Swal.fire("Carrito vacío", "Agrega productos al carrito antes de finalizar la compra.", "warning");
            } else {
                // Redirigir a pago.html
                window.location.href = "pago.html";
            }
        });
    });
</script>
    <div id="footer-wrapper"></div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.min.js"></script>
    <script src="https://rsienterprise.com/javascripts/includesVisita.js"></script>
    <script src="https://rsienterprise.com/javascripts/navScript.js"></script>
    <script type="module">
        import { initAuthCheck } from '../../javascripts/user/authUser.js';
        // Inicializar la verificación de autenticación para usuarios normales
        initAuthCheck("user");
    </script>
</body>
</html>