<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toma de Asistencias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --dark: #1c1948;
            --light: #f0f2ff;
            --success: #4CAF50;
            --error: #f44336;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(78, 84, 200, 0.3);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f8 100%);
            color: #333;
            overflow-x: hidden;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Contenedor principal con efecto vidrio */
        .attendance-container {
            max-width: 850px;
            margin: 40px auto;
            padding: 40px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: var(--transition);
        }

        .attendance-container.loaded {
            transform: translateY(0);
            opacity: 1;
        }

        /* Encabezado con gradiente */
        .attendance-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            opacity: 0;
            transform: translateY(-10px);
            transition: var(--transition);
        }

        .attendance-container.loaded .attendance-header {
            opacity: 1;
            transform: translateY(0);
        }

        .attendance-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .attendance-header p {
            color: #666;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .attendance-header::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        /* Tarjeta de empleado con efecto 3D */
        .employee-info {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 40px;
            padding: 25px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transform-style: preserve-3d;
            transform: perspective(500px);
            opacity: 0;
            transform: translateX(-20px) rotateY(15deg);
            transition: var(--transition);
            border-left: 5px solid var(--primary);
        }

        .attendance-container.loaded .employee-info {
            opacity: 1;
            transform: translateX(0) rotateY(0);
        }

        .employee-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--white);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 3px;
        }

        .employee-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 10px 25px rgba(78, 84, 200, 0.4);
        }

        .employee-details h3 {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .employee-details p {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        /* Fecha con efecto neón */
        .attendance-date {
            text-align: center;
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 30px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(78, 84, 200, 0.2);
            opacity: 0;
            transform: scale(0.9);
            transition: var(--transition);
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
        }

        .attendance-container.loaded .attendance-date {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        .attendance-date::before {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
        }

        /* Opciones con efecto tarjeta de crédito */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .attendance-option {
            position: relative;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid #f0f0f0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) rotateX(20deg);
            perspective: 1000px;
            transform-style: preserve-3d;
        }

        .attendance-container.loaded .attendance-option {
            opacity: 1;
            transform: translateY(0) rotateX(0);
        }

        /* Animación escalonada para cada opción */
        .attendance-option:nth-child(1) { transition-delay: 0.3s; }
        .attendance-option:nth-child(2) { transition-delay: 0.4s; }
        .attendance-option:nth-child(3) { transition-delay: 0.5s; }
        .attendance-option:nth-child(4) { transition-delay: 0.6s; }

        .attendance-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            transform: scaleX(0);
            transform-origin: left;
            transition: var(--transition);
        }

        .attendance-option:hover {
            transform: translateY(-10px) rotateX(5deg) !important;
            box-shadow: 0 15px 30px rgba(233, 211, 15, 0.15);
            border-color: var(--secondary);
        }

        .attendance-option:hover::before {
            transform: scaleX(1);
        }

        .attendance-option.selected {
            border-color: var(--primary);
            background-color: var(--light);
            animation: pulse 0.6s ease;
            box-shadow: 0 10px 25px rgba(78, 84, 200, 0.2);
        }

        .attendance-option.selected::before {
            transform: scaleX(1);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .option-icon {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--primary);
            transition: var(--transition);
            text-shadow: 0 5px 15px rgba(78, 84, 200, 0.3);
        }

        .attendance-option:hover .option-icon {
            transform: scale(1.2);
            color: var(--secondary);
        }

        .option-label {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .option-desc {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
        }

        .checkbox {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 25px;
            height: 25px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: var(--white);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attendance-option.selected .checkbox {
            background-color: var(--primary);
            border-color: var(--primary);
            animation: checkBounce 0.6s ease;
        }

        @keyframes checkBounce {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.2); }
            60% { transform: scale(0.9); }
        }

        .checkbox::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--white);
            font-size: 14px;
            opacity: 0;
            transition: var(--transition);
        }

        .attendance-option.selected .checkbox::after {
            opacity: 1;
        }

        /* Botón con efecto 3D */
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease 0.7s;
            z-index: 1;
        }

        .attendance-container.loaded .submit-btn {
            opacity: 1;
            transform: translateY(0);
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, var(--secondary), var(--primary));
            transition: var(--transition);
            z-index: -1;
        }

        .submit-btn:hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 10px 25px rgba(78, 84, 200, 0.6);
        }

        .submit-btn:hover::before {
            left: 0;
        }

        .submit-btn:active {
            transform: translateY(2px) !important;
            box-shadow: 0 3px 10px rgba(78, 84, 200, 0.4);
        }

        .submit-btn i {
            margin-right: 10px;
            transition: var(--transition);
        }

        .submit-btn:hover i {
            transform: rotate(15deg) scale(1.2);
        }

        /* Alerta premium */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(5px);
        }
        
        .alert-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .alert-box {
            background: linear-gradient(145deg, #ffffff, #f8f9ff);
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.8) rotateX(30deg);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .alert-overlay.show .alert-box {
            transform: scale(1) rotateX(0);
        }
        
        .alert-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        
        .alert-icon {
            font-size: 80px;
            color: var(--success);
            margin-bottom: 25px;
            animation: bounceIn 0.8s;
            text-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        /* Estilos para la alerta de error */
        .error-alert-box .alert-icon {
            color: var(--error);
            text-shadow: 0 10px 20px rgba(244, 67, 54, 0.3);
        }
        
        .error-alert-box::before {
            background: linear-gradient(to right, var(--error), #ff6b6b);
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        .alert-title {
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .alert-message {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .alert-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .error-alert-box .alert-btn {
            background: linear-gradient(to right, var(--error), #ff6b6b);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .alert-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, var(--secondary), var(--primary));
            transition: var(--transition);
            z-index: -1;
        }
        
        .error-alert-box .alert-btn::before {
            background: linear-gradient(to right, #ff6b6b, var(--error));
        }
        
        .alert-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(78, 84, 200, 0.6);
        }
        
        .error-alert-box .alert-btn:hover {
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.6);
        }
        
        .alert-btn:hover::before {
            left: 0;
        }
        
        .alert-btn:active {
            transform: translateY(1px);
        }

                /* Nuevos estilos para la alerta de ubicación */
        .location-alert-box {
            background: linear-gradient(145deg, #ffffff, #f8f9ff);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.8) rotateX(30deg);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .location-alert-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        
        .location-alert-logo {
            max-width: 200px;
            margin: 0 auto 20px;
            display: block;
        }
        
        .location-alert-title {
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .location-alert-message {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .location-alert-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .location-alert-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, var(--secondary), var(--primary));
            transition: var(--transition);
            z-index: -1;
        }
        
        .location-alert-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(78, 84, 200, 0.6);
        }
        
        .location-alert-btn:hover::before {
            left: 0;
        }
        
        .location-alert-btn:active {
            transform: translateY(1px);
        }
        
        .location-alert-icon {
            font-size: 50px;
            color: var(--primary);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .attendance-container {
                margin: 20px;
                padding: 25px;
                border-radius: 15px;
            }

            .attendance-header h1 {
                font-size: 2rem;
            }

            .employee-info {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            .employee-avatar {
                width: 80px;
                height: 80px;
                margin-bottom: 15px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .attendance-option {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .attendance-container {
                margin: 15px;
                padding: 20px;
            }

            .attendance-header h1 {
                font-size: 1.8rem;
            }

            .employee-details h3 {
                font-size: 1.3rem;
            }

            .option-icon {
                font-size: 2rem;
                margin-bottom: 15px;
            }

            .option-label {
                font-size: 1rem;
            }

            .submit-btn {
                padding: 15px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="attendance-container" id="attendanceContainer">
        <div class="attendance-header">
            <h1>Toma de Asistencias</h1>
            <p>Registra tu estatus laboral para el día de hoy</p>
        </div>

        <div class="employee-info">
            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Empleado" class="employee-avatar" id="employeeAvatar">
            <div class="employee-details">
                <h3></h3>
                <p>Departamento: Desarrollo</p>
                <p>ID: EMP-2023-0456</p>
            </div>
        </div>

        <div class="attendance-options">
            <div class="attendance-date" id="attendanceDate">
                <i class="fas fa-calendar-day"></i> <span id="currentDate"></span>
            </div>

            <div class="options-grid">
                <div class="attendance-option" data-value="office">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-building"></i></div>
                    <div class="option-label">En oficina</div>
                    <div class="option-desc">Asistencia presencial en oficina principal</div>
                </div>

                <div class="attendance-option" data-value="site">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="option-label">En sitio</div>
                    <div class="option-desc">Trabajando en ubicación del cliente</div>
                </div>

                <div class="attendance-option" data-value="iztapaluca">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-building"></i></div>
                    <div class="option-label">En oficina de Ixtapaluca</div>
                    <div class="option-desc">Trabajando en oficina de Ixtapaluca</div>
                </div>

                <div class="attendance-option" data-value="sick">
                    <div class="checkbox"></div>
                    <div class="option-icon"><i class="fas fa-procedures"></i></div>
                    <div class="option-label">Incapacidad</div>
                    <div class="option-desc">Ausencia por enfermedad/incapacidad</div>
                </div>
            </div>
        </div>

        <button class="submit-btn" id="submitAttendance">
            <i class="fas fa-check-circle"></i> Registrar Asistencia
        </button>
    </div>

    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-box">
            <div class="alert-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="alert-title">¡Asistencia registrada!</h3>
            <p class="alert-message">Tu asistencia ha sido registrada correctamente para el día de hoy.</p>
            <button class="alert-btn" id="alertBtn">Aceptar</button>
        </div>
    </div>

    <!-- Alerta de error -->
    <div class="alert-overlay" id="errorAlert">
        <div class="alert-box error-alert-box">
            <div class="alert-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3 class="alert-title">¡Selecciona una opción!</h3>
            <p class="alert-message">Debes seleccionar un tipo de asistencia antes de continuar.</p>
            <button class="alert-btn" id="errorBtn">Entendido</button>
        </div>
    </div>

<div class="alert-overlay" id="locationOverlay">
    <div class="alert-box">
        <div class="alert-icon">
            <i class="fas fa-map-marker-alt"></i> <!-- Icono apropiado -->
        </div>
        <h3 class="alert-title">Ubicación requerida</h3>
        <p class="alert-message">Para registrar tu asistencia, necesitamos acceder a tu ubicación actual. Por favor, permite el acceso a la geolocalización.</p>
        <button class="alert-btn" id="locationBtn">Permitir ubicación</button>
    </div>
</div>


    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>

document.addEventListener('DOMContentLoaded', function() {
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBJy992gkvsT77-_fMp_O_z99wtjZiK77Y",
        authDomain: "rsienterprise.firebaseapp.com",
        databaseURL: "https://rsienterprise-default-rtdb.firebaseio.com",
        projectId: "rsienterprise",
        storageBucket: "rsienterprise.appspot.com",
        messagingSenderId: "1063117165770",
        appId: "1:1063117165770:web:8555f26b25ae80bc42d033",
        measurementId: "G-38F2DBG9HE"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // Elementos del DOM
    const attendanceContainer = document.getElementById('attendanceContainer');
    const employeeAvatar = document.getElementById('employeeAvatar');
    const employeeDetails = document.querySelector('.employee-details');
    const currentDateElement = document.getElementById('currentDate');
    const attendanceOptions = document.querySelectorAll('.attendance-option');
    const submitBtn = document.getElementById('submitAttendance');
    const optionsGrid = document.querySelector('.options-grid');
    const alertOverlay = document.getElementById('alertOverlay');
    const alertBtn = document.getElementById('alertBtn');
    const errorAlert = document.getElementById('errorAlert');
    const errorBtn = document.getElementById('errorBtn');
    const alertTitle = document.querySelector('.alert-title');
    const alertMessage = document.querySelector('.alert-message');
    const locationOverlay = document.getElementById('locationOverlay');
    const locationBtn = document.getElementById('locationBtn');

    
        // Función para obtener el rol del usuario desde la colección 'usuarios'
async function getUserRole(email) {
    try {
        const querySnapshot = await db.collection('usuarios')
            .where('email', '==', email)
            .limit(1)
            .get();

        if (!querySnapshot.empty) {
            return querySnapshot.docs[0].data().rol;
        }
          return null;
    } catch (error) {
        console.error("Error al obtener rol del usuario:", error);
        return null;
    }
}

    // Animación de carga inicial
    setTimeout(() => {
        attendanceContainer.classList.add('loaded');
    }, 100);

    // Mostrar fecha y hora actual
    function updateDateTime() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        currentDateElement.textContent = now.toLocaleDateString('es-ES', options);
    }

    // Actualizar cada segundo
    updateDateTime();
    setInterval(updateDateTime, 1000);

    async function getUserData(email) {
        try {
            // Primero intentar con búsqueda exacta
            let querySnapshot = await db.collection('colaboradores')
                .where('CORREO ELECTRÓNICO EMPRESARIAL', '==', email)
                .limit(1)
                .get();

            // Si no se encuentra, intentar con búsqueda flexible
            if (querySnapshot.empty) {
                querySnapshot = await db.collection('colaboradores')
                    .where('CORREO ELECTRÓNICO EMPRESARIAL', '>=', email.toLowerCase())
                    .where('CORREO ELECTRÓNICO EMPRESARIAL', '<=', email.toLowerCase() + '\uf8ff')
                    .limit(1)
                    .get();
            }

            if (!querySnapshot.empty) {
                return { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
            }
            
            return null;
        } catch (error) {
            console.error("Error al obtener datos del usuario:", error);
            return null;
        }
    }

    // Función mejorada para verificar estado activo desde colaboradores
async function checkActiveAttendanceFromCollaborators(email) {
    try {
        const collaboratorQuery = await db.collection('colaboradores')
            .where('CORREO ELECTRÓNICO EMPRESARIAL', '==', email)
            .limit(1)
            .get();

        if (collaboratorQuery.empty) {
            console.log("No se encontró el colaborador con ese correo");
            return null;
        }

        const collaboratorData = collaboratorQuery.docs[0].data();
        const collaboratorId = collaboratorQuery.docs[0].id;

        // Verificar si tiene asistencia registrada hoy y estado es true
        if (collaboratorData.asistencia?.estado === true && collaboratorData.asistencia?.fecha) {
            const lastAttendanceDate = collaboratorData.asistencia.fecha.toDate();
            const today = new Date();
            
            // Comparar si la última asistencia fue hoy
            if (
                lastAttendanceDate.getDate() === today.getDate() &&
                lastAttendanceDate.getMonth() === today.getMonth() &&
                lastAttendanceDate.getFullYear() === today.getFullYear()
            ) {
                return {
                    id: collaboratorId,
                    ...collaboratorData,
                    horaRegistro: lastAttendanceDate.toLocaleTimeString('es-ES')
                };
            }
        }
        
        return null;
    } catch (error) {
        console.error("Error al verificar asistencia activa:", error);
        return null;
    }
}

    // Función para verificar si ya existe asistencia hoy
    async function checkExistingAttendance(email) {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const attendanceRef = db.collection('asistencias');
            const query = attendanceRef.where('correoEmpresarial', '==', email)
                                    .where('fecha', '>=', firebase.firestore.Timestamp.fromDate(today))
                                    .where('fecha', '<', firebase.firestore.Timestamp.fromDate(tomorrow))
                                    .limit(1);
            
            const querySnapshot = await query.get();
            return !querySnapshot.empty;
        } catch (error) {
            console.error("Error al verificar asistencia:", error);
            return false;
        }
    }

    // Mostrar información del usuario
function displayUserInfo(user) {
    employeeDetails.innerHTML = `
        <h3>${user.NOMBRE || 'Nombre no disponible'}</h3>
        <p><strong>Área:</strong> ${user['ÁREA'] || 'No especificado'}</p>
        <p><strong>ID Empleado:</strong> ${user.NIT || 'ID no disponible'}</p>
        <p><strong>RFC:</strong> ${user.RFC || 'No disponible'}</p>
        <p><strong>Teléfono:</strong> ${user['TELÉFONO MOVIL'] || 'No disponible'}</p>
        <p><strong>Asistencia hoy:</strong> ${user.asistencia?.estado ? '<span style="color: var(--success);">Presente</span>' : '<span style="color: var(--error);">Pendiente</span>'}</p>
    `;
    
    // Si el usuario tiene imagen de perfil
    if (user.imagen) {
        employeeAvatar.src = user.imagen;
    } else {
        // Si no tiene imagen, usar iniciales
        const name = user.NOMBRE || '';
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
        employeeAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=4e54c8&color=fff&size=128`;
    }
}

    // Variable para almacenar las coordenadas
    let userCoordinates = null;
    
    // Función para obtener la ubicación
    function getLocation() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                // Agregar timeout independiente para mayor control
                const timeout = setTimeout(() => {
                    reject(new Error("Tiempo de espera agotado al obtener ubicación"));
                }, 15000); // 15 segundos

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(timeout); // Limpiar timeout cuando se resuelva
                        
                        // Verificar que la precisión sea aceptable (ej. menos de 100 metros)
                        if (position.coords.accuracy > 100) {
                            reject(new Error("La precisión de la ubicación es demasiado baja. Intenta en un área con mejor señal."));
                            return;
                        }

                        userCoordinates = {
                            latitude: Math.round(position.coords.latitude * 1000) / 1000, // Redondear para privacidad
                            longitude: Math.round(position.coords.longitude * 1000) / 1000, // Redondear para privacidad
                            accuracy: position.coords.accuracy,
                            timestamp: firebase.firestore.Timestamp.fromDate(new Date())
                        };
                        
                        // Almacenar coordenadas en sessionStorage para persistencia
                        sessionStorage.setItem('userCoordinates', JSON.stringify(userCoordinates));
                        
                        // Mostrar feedback visual de la precisión
                        updateAccuracyIndicator(position.coords.accuracy);
                        
                        resolve(userCoordinates);
                    },
                    (error) => {
                        clearTimeout(timeout); // Limpiar timeout en caso de error
                        console.error("Error al obtener ubicación:", error);
                        
                        let errorMessage = "Error desconocido";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Permiso de ubicación denegado. Por favor habilita los permisos.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "La información de ubicación no está disponible.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "La solicitud de ubicación ha caducado. Intenta nuevamente.";
                                break;
                        }
                        
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                reject(new Error("Geolocalización no soportada por el navegador"));
            }
        });
    }
    
    // Mostrar feedback visual de la precisión
    function updateAccuracyIndicator(accuracy) {
        const accuracyElement = document.getElementById('accuracyIndicator');
        if (accuracyElement) {
            accuracyElement.textContent = `Precisión: ~${Math.round(accuracy)} metros`;
            accuracyElement.style.color = accuracy < 50 ? 'green' : accuracy < 100 ? 'orange' : 'red';
        }
    }
    
    // Función fallback para cuando la geolocalización falle
    async function getFallbackLocation() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                latitude: data.latitude,
                longitude: data.longitude,
                accuracy: 5000, // Baja precisión
                source: 'ip'
            };
        } catch (error) {
            return null;
        }
    }

// Función para registrar asistencia (modificada)
async function registerAttendance(attendanceType, userData) {
    try {
        const now = new Date();
        const timestamp = firebase.firestore.Timestamp.fromDate(now);
        
        // Verificar si tenemos coordenadas o intentar obtenerlas
        if (!userCoordinates) {
            try {
                const storedCoords = sessionStorage.getItem('userCoordinates');
                if (storedCoords) {
                    userCoordinates = JSON.parse(storedCoords);
                } else {
                    // Intentar obtener ubicación nuevamente
                    userCoordinates = await getLocation();
                }
            } catch (error) {
                console.warn("No se pudo obtener ubicación precisa, intentando con fallback...");
                userCoordinates = await getFallbackLocation();
            }
        }
        
        // 1. Actualizar primero el estado en colaboradores
        await db.collection('colaboradores').doc(userData.id).update({
            asistencia: {
                estado: true,
                tipo: attendanceType,
                fecha: timestamp,
            },
            ultimaAsistencia: timestamp
        });

        // 2. Luego registrar la asistencia
        const attendanceData = {
            userId: userData.id,
            email: userData['CORREO ELECTRÓNICO EMPRESARIAL'],
            nombre: userData.NOMBRE,
            area: userData['ÁREA'],
            tipo: attendanceType,
            fecha: timestamp,
            dia: now.toLocaleDateString('es-ES', { weekday: 'long' }),
            horaRegistro: now.toLocaleTimeString('es-ES'),
            activo: true,
            ubicacion: userCoordinates,
            detalles: {
                correoPersonal: userData['CORREO ELECTRONICO PERSONAL'],
                correoEmpresarial: userData['CORREO ELECTRÓNICO EMPRESARIAL'],
                rfc: userData.RFC,
                nss: userData.NSS,
                curp: userData.CURP
            }
        };

        const batch = db.batch();
        const attendanceRef = db.collection('asistencias').doc();
        batch.set(attendanceRef, attendanceData);
        await batch.commit();
        
        // Obtener el rol del usuario para redireccionamiento
        const userRole = await getUserRole(userData['CORREO ELECTRÓNICO EMPRESARIAL']);
        
        // Mostrar mensaje de éxito con ubicación aproximada
        const ubicacionMsg = attendanceType === 'office' || attendanceType === 'iztapaluca' ? 
            'Oficina verificada' : 
            'Ubicación del cliente verificada';
        
        showAlert(
            'success', 
            'Asistencia registrada', 
            `Tu asistencia ha sido registrada correctamente.<br>
            <strong>Tipo:</strong> ${getAttendanceTypeName(attendanceType)}<br>
            <strong>Ubicación:</strong> ${ubicacionMsg}<br>
            Serás redirigido en 3 segundos...`
        );
        
        // Redirigir según el rol después de 3 segundos
        setTimeout(() => {
            redirectByRole(userRole);
        }, 3000);

        return true;
    } catch (error) {
        console.error("Error al registrar asistencia:", error);
        return false;
    }
}

// Función para redireccionar según el rol (versión corregida)
function redirectByRole(role) {
    switch(role) {
        case 'puntoVenta':
            window.location.href = '../nav-puntoVenta/inicio.html';
            break;
        case 'facturas':
            window.location.href = '../nav-facturas/facturas.html';
            break;
        case 'colaborador':
            window.location.href = '../nav-operadores/gestion_Tickets.html';
            break;
        case 'admincolaborador':
            window.location.href = '../nav-mesa/gestion-tickets.html';
            break;
        default:
            window.location.href = "../nav-operadores/gestion_Tickets.html";
    }
}

// Configurar el botón de enviar con los datos del usuario (modificado)
function setupSubmitButton(userData) {
    submitBtn.addEventListener('click', async function() {
        const selectedOption = document.querySelector('.attendance-option.selected');
        
        if (!selectedOption) {
            errorAlert.classList.add('show');
            if(optionsGrid) {
                optionsGrid.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    optionsGrid.style.animation = '';
                }, 500);
            }
            return;
        }

        const attendanceType = selectedOption.getAttribute('data-value');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
        submitBtn.disabled = true;

        const success = await registerAttendance(attendanceType, userData);
        
        if (!success) {
            showAlert(
                'error', 
                'Error al registrar', 
                'Hubo un problema al registrar tu asistencia. Por favor intenta nuevamente.'
            );
            submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Registrar Asistencia';
            submitBtn.disabled = false;
        }
    });
}

    // Función auxiliar para obtener el nombre del tipo de asistencia
    function getAttendanceTypeName(type) {
        const types = {
            'office': 'En oficina',
            'site': 'En sitio',
            'iztapaluca': 'En oficina de Iztapaluca',
            'sick': 'Incapacidad'
        };
        return types[type] || type;
    }

    // Configurar el botón de ubicación
    locationBtn.addEventListener('click', async function() {
        locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicación...';
        locationBtn.disabled = true;
        
        try {
            await getLocation();
            locationOverlay.classList.remove('show');
            
            // Mostrar mensaje de éxito
            showAlert(
                'success', 
                'Ubicación verificada', 
                'Gracias por activar tu ubicación. Ahora puedes registrar tu asistencia con total seguridad.'
            );
            
            // Continuar con el flujo normal de la aplicación
            initApp();
        } catch (error) {
            console.error("Error al obtener ubicación:", error);
            
            // Mostrar mensaje de error específico
            showAlert(
                'error', 
                'Ubicación requerida', 
                error.message || 'No podemos continuar sin acceso a tu ubicación. Por favor, actualiza la página e intenta nuevamente.'
            );
            
            locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Intentar nuevamente';
            locationBtn.disabled = false;
        }
    });

    // Función para inicializar la aplicación después de obtener ubicación
    function initApp() {
        // Tu lógica de inicialización existente...
    }

    // Función para mostrar alertas
function showAlert(type, title, message) {
    // Ocultar todas las alertas primero
    alertOverlay.classList.remove('show');
    errorAlert.classList.remove('show');
    
    if (type === 'error') {
        // Configurar alerta de error
        document.querySelector('#errorAlert .alert-title').textContent = title;
        document.querySelector('#errorAlert .alert-message').innerHTML = message;
        errorAlert.classList.add('show');
    } else {
        // Configurar alerta normal (éxito/info)
        document.querySelector('#alertOverlay .alert-title').textContent = title;
        document.querySelector('#alertOverlay .alert-message').innerHTML = message;
        alertOverlay.classList.add('show');
    }
    
    // Configurar el icono según el tipo
    const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
    const iconElement = type === 'error' 
        ? document.querySelector('#errorAlert .alert-icon i') 
        : document.querySelector('#alertOverlay .alert-icon i');
    iconElement.className = `fas ${icon}`;
}

// Observador de autenticación modificado para verificar rol
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // Obtener el rol del usuario
        const userRole = await getUserRole(user.email);
        
        // Verificar si el rol está permitido (todos menos 'user' y 'admin')
        if (userRole === 'user' || userRole === 'admin') {
            showAlert('error', 'Acceso denegado', 
                     'No tienes permisos para acceder a esta función. Serás redirigido.');
            
            setTimeout(() => {
                auth.signOut().then(() => {
                    window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
                });
            }, 3000);
            return;
        }
        
        // Resto de la lógica existente...
        const activeAttendance = await checkActiveAttendanceFromCollaborators(user.email);
        
        if (activeAttendance) {
            displayUserInfo(activeAttendance);
            
            showAlert(
                'info', 
                '¡Asistencia ya registrada hoy!', 
                `Ya registraste tu asistencia hoy a las ${activeAttendance.horaRegistro}.<br>
                Serás redirigido al panel en 3 segundos...`
            );
            
            // Redirigir según el rol
            setTimeout(() => {
                redirectByRole(userRole);
            }, 3000);
        } else {
            const userData = await getUserData(user.email);
            
            if (!userData) {
                console.error("No se encontraron datos para el usuario");
                showAlert('error', 'Datos no encontrados', 
                         'No se encontraron datos para este usuario. Serás redirigido a la página de inicio de sesión.');
                
                setTimeout(() => {
                    auth.signOut().then(() => {
                        window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
                    });
                }, 3000);
                return;
            }
            
            displayUserInfo(userData);
            
            const storedCoords = sessionStorage.getItem('userCoordinates');
            if (storedCoords) {
                userCoordinates = JSON.parse(storedCoords);
            } else {
                locationOverlay.classList.add('show');
            }
            
            setupSubmitButton(userData);
        }
        } else {
        window.location.href = "/vista/nav-visitantes/inicio-de-sesion.html";
    }
});

    // Botón de alerta
    alertBtn.addEventListener('click', function() {
        alertOverlay.classList.remove('show');
    });
    
    // Botón de alerta de error
    errorBtn.addEventListener('click', function() {
        errorAlert.classList.remove('show');
    });

    locationBtn.addEventListener('click', function() {
    locationOverlay.classList.remove('show');
});

    // Animación de shake
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(78, 84, 200, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // Selección de opciones de asistencia
    attendanceOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Deseleccionar todas las opciones
            attendanceOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Seleccionar la opción clickeada
            this.classList.add('selected');
        });
    });
});
    
</script>
</body>
</html>